(()=>{function C({uint8View:t,dataView:e,bufferStart:s,bufferSize:o,head:i,tail:D,messageMagic:R,paddingMagic:m,headerSize:c,maxMessages:y=1/0,onMessage:b,onCorruption:f}){let r=D,T=0;for(;r!==i&&T<y;){if(o-r<c){r=0;continue}let g=s+r,d=e.getUint32(g,!0);if(d===m){r=0;continue}if(d!==R){f&&f(r),r=(r+1)%o;continue}let _=e.getUint32(g+4,!0),w=e.getUint32(g+8,!0);if(_<c||_>o){f&&f(r),r=(r+1)%o;continue}let x=_-c,L=g+c,B=new Uint8Array(x);for(let S=0;S<x;S++)B[S]=t[L+S];b(B,w,_),r=(r+_)%o,T++}return{newTail:r,messagesRead:T}}var p="sab",l=null,u=null,n=null,I=null,M=null,E=null,a={},U=null,A=!1,G=new TextDecoder("utf-8"),k=(...t)=>{},H=(t,e,s)=>{l=t,u=e,E=s,n=new Int32Array(l),I=new DataView(l),M=new Uint8Array(l),a={DEBUG_HEAD:(u+E.CONTROL_START+16)/4,DEBUG_TAIL:(u+E.CONTROL_START+20)/4};let o=u+E.METRICS_START;U=new Uint32Array(l,o,E.METRICS_SIZE/4)},h=()=>{let t=Atomics.load(n,a.DEBUG_HEAD),e=Atomics.load(n,a.DEBUG_TAIL);if(t===e)return null;let s=[],{newTail:o,messagesRead:i}=C({uint8View:M,dataView:I,bufferStart:u+E.DEBUG_BUFFER_START,bufferSize:E.DEBUG_BUFFER_SIZE,head:t,tail:e,messageMagic:E.MESSAGE_MAGIC,paddingMagic:E.PADDING_MAGIC,headerSize:E.MESSAGE_HEADER_SIZE,maxMessages:1e3,onMessage:(D,R,m)=>{let c=G.decode(D);c.endsWith(`
`)&&(c=c.slice(0,-1)),s.push({text:c,timestamp:performance.now(),sequence:R}),U&&(Atomics.add(U,20,1),Atomics.add(U,21,D.length))},onCorruption:D=>{console.error("[DebugWorker] Corrupted message at position",D)}});return i>0&&Atomics.store(n,a.DEBUG_TAIL,o),s.length>0?s:null},W=()=>{for(;A;)try{let t=Atomics.load(n,a.DEBUG_HEAD),e=Atomics.load(n,a.DEBUG_TAIL);if(t===e){let o=Atomics.wait(n,a.DEBUG_HEAD,t,100);if(!(o==="ok"||o==="not-equal")){if(o==="timed-out")continue}}let s=h();s&&s.length>0&&self.postMessage({type:"debug",messages:s})}catch(t){console.error("[DebugWorker] Error in wait loop:",t),self.postMessage({type:"error",error:t.message}),Atomics.wait(n,0,n[0],10)}},F=()=>{if(!l){console.error("[DebugWorker] Cannot start - not initialized");return}if(A){console.warn("[DebugWorker] Already running");return}A=!0,W()},Q=()=>{A=!1},Y=()=>{l&&(Atomics.store(n,a.DEBUG_HEAD,0),Atomics.store(n,a.DEBUG_TAIL,0))},V=t=>{let e=[];for(let s of t)try{let o=new Uint8Array(s.bytes),i=G.decode(o);i.endsWith(`
`)&&(i=i.slice(0,-1)),e.push({text:i,timestamp:performance.now(),sequence:s.sequence})}catch(o){console.error("[DebugWorker] Failed to decode message:",o)}e.length>0&&self.postMessage({type:"debug",messages:e})};self.addEventListener("message",t=>{let{data:e}=t;try{switch(e.type){case"init":p=e.mode||"sab",p==="sab"&&H(e.sharedBuffer,e.ringBufferBase,e.bufferConstants),self.postMessage({type:"initialized"});break;case"start":p==="sab"&&F();break;case"stop":Q();break;case"clear":p==="sab"&&Y();break;case"debugRaw":e.messages&&V(e.messages);break;default:console.warn("[DebugWorker] Unknown message type:",e.type)}}catch(s){console.error("[DebugWorker] Error:",s),self.postMessage({type:"error",error:s.message})}});k("[DebugWorker] Script loaded");})();
