(()=>{function F(e,t,n){return(n-1-e+t)%n}function k({uint8View:e,dataView:t,bufferStart:n,bufferSize:s,head:c,payload:o,sequence:d,messageMagic:h,headerSize:S}){let U=o.length,m=S+U+3&-4,g=s-c;if(m>g){let u=new Uint8Array(S),R=new DataView(u.buffer);R.setUint32(0,h,!0),R.setUint32(4,m,!0),R.setUint32(8,d,!0),R.setUint32(12,0,!0);let I=n+c,x=n;if(g>=S){e.set(u,I);let P=g-S;P>0&&e.set(o.subarray(0,P),I+S),e.set(o.subarray(P),x)}else{e.set(u.subarray(0,g),I),e.set(u.subarray(g),x);let P=S-g;e.set(o,x+P)}}else{let u=n+c;t.setUint32(u,h,!0),t.setUint32(u+4,m,!0),t.setUint32(u+8,d,!0),t.setUint32(u+12,0,!0),e.set(o,u+S)}return(c+m)%s}function le(e,t,n=0){for(let s=0;s<=n;s++)if(Atomics.compareExchange(e,t,0,1)===0)return!0;return!1}function ie(e,t){Atomics.store(e,t,0)}function G({atomicView:e,dataView:t,uint8View:n,bufferConstants:s,ringBufferBase:c,controlIndices:o,oscMessage:d,maxSpins:h=0}){let S=d.length,U=s.MESSAGE_HEADER_SIZE+S;if(U>s.IN_BUFFER_SIZE-s.MESSAGE_HEADER_SIZE||!le(e,o.IN_WRITE_LOCK,h))return!1;try{let O=Atomics.load(e,o.IN_HEAD),m=Atomics.load(e,o.IN_TAIL),g=U+3&-4;if(F(O,m,s.IN_BUFFER_SIZE)<g)return!1;let R=Atomics.add(e,o.IN_SEQUENCE,1),I=k({uint8View:n,dataView:t,bufferStart:c+s.IN_BUFFER_START,bufferSize:s.IN_BUFFER_SIZE,head:O,payload:d,sequence:R,messageMagic:s.MESSAGE_MAGIC,headerSize:s.MESSAGE_HEADER_SIZE});return Atomics.load(e,o.IN_HEAD),Atomics.store(e,o.IN_HEAD,I),!0}finally{ie(e,o.IN_WRITE_LOCK)}}var p="sab",T=null,_=null,a=null,w=null,z=null,$=null,j={},i=null,D=null,Y=null,B=25,A=(e,t)=>{i&&(p==="sab"?Atomics.store(i,e,t):i[e]=t)},J=e=>i?p==="sab"?Atomics.load(i,e):i[e]:0,f=(e,t)=>{i&&(p==="sab"?Atomics.add(i,e,t):i[e]+=t)},Se=()=>{if(p!=="postMessage"||Y!==null)return;let e=()=>{D&&i&&self.postMessage({type:"preschedulerMetrics",metrics:new Uint32Array(D.slice(0))}),Y=setTimeout(e,B)};e(),E("[PreScheduler] Started metrics sending (every "+B+"ms)")};var r=[],ee=null,ge=0,W=!1,l=[],K=5,C=65536,pe=2208988800,te=25,de=.2,E=(...e)=>{},se=()=>(performance.timeOrigin+performance.now())/1e3+pe,Te=e=>{if(e.length>=16&&e[0]===35){let t=new DataView(e.buffer,e.byteOffset),n=t.getUint32(8,!1),s=t.getUint32(12,!1);return n+s/4294967296}return null};var _e=()=>{if(!T||!a){console.error("[PreScheduler] Cannot init - missing buffer or constants");return}w=new Int32Array(T),z=new DataView(T),$=new Uint8Array(T),j={IN_HEAD:(_+a.CONTROL_START+0)/4,IN_TAIL:(_+a.CONTROL_START+4)/4,IN_SEQUENCE:(_+a.CONTROL_START+24)/4,IN_WRITE_LOCK:(_+a.CONTROL_START+40)/4};let e=_+a.METRICS_START;i=new Uint32Array(T,e,a.METRICS_SIZE/4),E("[PreScheduler] SharedArrayBuffer initialized with direct ring buffer writing and metrics")},N=()=>{if(!i)return;A(6,r.length);let e=r.length,t=J(7);e>t&&A(7,e)},M=(e,t,n=null)=>{if(p==="postMessage")return self.postMessage({type:"dispatch",oscData:e,timestamp:n}),f(8,1),!0;if(!T||!w)return console.error("[PreScheduler] Not initialized for ring buffer writing"),!1;let s=e.length,c=a.MESSAGE_HEADER_SIZE+s;return c>a.IN_BUFFER_SIZE-a.MESSAGE_HEADER_SIZE?(console.error("[PreScheduler] Message too large:",c),!1):G({atomicView:w,dataView:z,uint8View:$,bufferConstants:a,ringBufferBase:_,controlIndices:j,oscMessage:e,maxSpins:10})?(f(8,1),!0):(t||console.warn("[PreScheduler] Ring buffer full, message will be queued for retry"),!1)},y=(e,t)=>{let n=r.length+l.length;if(n>=C){console.error("[PreScheduler] Backpressure: dropping retry ("+n+" pending)"),f(10,1);return}l.push({oscData:e,retryCount:0,context:t||"unknown",queuedAt:performance.now()}),A(15,l.length);let s=J(16);l.length>s&&A(16,l.length),E("[PreScheduler] Queued message for retry:",t,"queue size:",l.length)},he=()=>{if(l.length===0)return;let e=0;for(;e<l.length;){let t=l[e];if(M(t.oscData,!0))l.splice(e,1),f(9,1),f(14,1),A(15,l.length),E("[PreScheduler] Retry succeeded for:",t.context,"after",t.retryCount+1,"attempts");else if(t.retryCount++,f(14,1),t.retryCount>=K){let s=`Ring buffer full - dropped message after ${K} retries (${t.context})`;console.error("[PreScheduler]",s),l.splice(e,1),f(10,1),A(15,l.length),self.postMessage({type:"error",error:s})}else e++}},me=(e,t,n)=>{let s=r.length+l.length;if(s>=C)return console.warn("[PreScheduler] Backpressure: rejecting message ("+s+" pending)"),!1;let c=Te(e);if(c===null)return E("[PreScheduler] Non-bundle message, dispatching immediately"),M(e,!1)||y(e,"immediate message"),!0;let o=se(),d=c-o,h={ntpTime:c,seq:ge++,sessionId:t||0,runTag:n||"",oscData:e};return Re(h),f(11,1),N(),E("[PreScheduler] Scheduled bundle:","NTP="+c.toFixed(3),"current="+o.toFixed(3),"wait="+(d*1e3).toFixed(1)+"ms","pending="+r.length),!0},Re=e=>{r.push(e),Pe(r.length-1)},Ae=()=>r.length>0?r[0]:null,Ie=()=>{if(r.length===0)return null;let e=r[0],t=r.pop();return r.length>0&&(r[0]=t,ne(0)),e},Pe=e=>{for(;e>0;){let t=Math.floor((e-1)/2);if(b(r[e],r[t])>=0)break;re(e,t),e=t}},ne=e=>{let t=r.length;for(;;){let n=2*e+1,s=2*e+2,c=e;if(n<t&&b(r[n],r[c])<0&&(c=n),s<t&&b(r[s],r[c])<0&&(c=s),c===e)break;re(e,c),e=c}},b=(e,t)=>e.ntpTime===t.ntpTime?e.seq-t.seq:e.ntpTime-t.ntpTime,re=(e,t)=>{let n=r[e];r[e]=r[t],r[t]=n},Me=()=>{if(ee!==null){console.warn("[PreScheduler] Polling already started");return}E("[PreScheduler] Starting periodic polling (every "+te+"ms)"),ce()};var ce=()=>{W=!0,he();let e=se(),t=e+de,n=0;for(;r.length>0;){let s=Ae();if(s.ntpTime<=t){Ie(),N();let c=s.ntpTime-e;f(13,1),E("[PreScheduler] Dispatching bundle:","NTP="+s.ntpTime.toFixed(3),"current="+e.toFixed(3),"early="+(c*1e3).toFixed(1)+"ms","remaining="+r.length),M(s.oscData,!1)||y(s.oscData,"scheduled bundle NTP="+s.ntpTime.toFixed(3)),n++}else break}(n>0||r.length>0||l.length>0)&&E("[PreScheduler] Dispatch cycle complete:","dispatched="+n,"pending="+r.length,"retrying="+l.length),W=!1,ee=setTimeout(ce,te)},H=e=>{if(r.length===0)return;let t=r.length,n=[];for(let c=0;c<r.length;c++){let o=r[c];e(o)||n.push(o)}let s=t-n.length;s>0&&(r=n,Ue(),f(12,s),N(),E("[PreScheduler] Cancelled "+s+" events, "+r.length+" remaining"))},Ue=()=>{for(let e=Math.floor(r.length/2)-1;e>=0;e--)ne(e)},De=(e,t)=>{H(n=>n.sessionId===e&&n.runTag===t)},Ce=e=>{H(t=>t.sessionId===e)},ye=e=>{H(t=>t.runTag===e)},Ne=()=>{if(r.length===0)return;let e=r.length;f(12,e),r=[],N(),E("[PreScheduler] Cancelled all "+e+" events")},Oe=e=>!e||e.length<8?!1:e[0]===35&&e[1]===98&&e[2]===117&&e[3]===110&&e[4]===100&&e[5]===108&&e[6]===101&&e[7]===0,xe=e=>{let t=[],n=new DataView(e.buffer,e.byteOffset,e.byteLength),s=16;for(;s<e.length;){let c=n.getInt32(s,!1);if(s+=4,c<=0||s+c>e.length)break;let o=e.slice(s,s+c);for(t.push(o),s+=c;s%4!==0&&s<e.length;)s++}return t},Le=e=>{if(Oe(e)){let t=xe(e);for(let n=0;n<t.length;n++)M(t[n],!1)||y(t[n],"immediate bundle message "+n)}else M(e,!1)||y(e,"immediate message")};self.addEventListener("message",e=>{let{data:t}=e;try{switch(t.type){case"init":p=t.mode||"sab",t.maxPendingMessages&&(C=t.maxPendingMessages),t.snapshotIntervalMs&&(B=t.snapshotIntervalMs),p==="sab"?(T=t.sharedBuffer,_=t.ringBufferBase,a=t.bufferConstants,_e()):(D=new ArrayBuffer(128),i=new Uint32Array(D),Se()),Me(),E("[OSCPreSchedulerWorker] Initialized with NTP-based scheduling, mode="+p+", capacity="+C),self.postMessage({type:"initialized"});break;case"send":me(t.oscData,t.sessionId||0,t.runTag||"");break;case"sendImmediate":Le(t.oscData);break;case"cancelSessionTag":t.runTag!==void 0&&t.runTag!==null&&t.runTag!==""&&De(t.sessionId||0,t.runTag);break;case"cancelSession":Ce(t.sessionId||0);break;case"cancelTag":t.runTag!==void 0&&t.runTag!==null&&t.runTag!==""&&ye(t.runTag);break;case"cancelAll":Ne();break;default:console.warn("[OSCPreSchedulerWorker] Unknown message type:",t.type)}}catch(n){console.error("[OSCPreSchedulerWorker] Error:",n),self.postMessage({type:"error",error:n.message})}});E("[OSCPreSchedulerWorker] Script loaded");})();
