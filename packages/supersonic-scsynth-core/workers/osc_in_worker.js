(()=>{function m({uint8View:e,dataView:t,bufferStart:r,bufferSize:o,head:C,tail:l,messageMagic:i,paddingMagic:u,headerSize:c,maxMessages:f=1/0,onMessage:F,onCorruption:A}){let s=l,I=0;for(;s!==C&&I<f;){if(o-s<c){s=0;continue}let U=r+s,g=t.getUint32(U,!0);if(g===u){s=0;continue}if(g!==i){A&&A(s),s=(s+1)%o;continue}let p=t.getUint32(U+4,!0),L=t.getUint32(U+8,!0);if(p<c||p>o){A&&A(s),s=(s+1)%o;continue}let d=p-c,B=U+c,x=new Uint8Array(d);for(let D=0;D<d;D++)x[D]=e[B+D];F(x,L,p),s=(s+p)%o,I++}return{newTail:s,messagesRead:I}}var _=null,T=null,E=null,P=null,y=null,n=null,S={},a=null,R=!1,H=(...e)=>{},O=-1,k=(e,t,r)=>{_=e,T=t,n=r,E=new Int32Array(_),P=new DataView(_),y=new Uint8Array(_),S={OUT_HEAD:(T+n.CONTROL_START+8)/4,OUT_TAIL:(T+n.CONTROL_START+12)/4};let o=T+n.METRICS_START;a=new Uint32Array(_,o,n.METRICS_SIZE/4)},W=()=>{let e=Atomics.load(E,S.OUT_HEAD),t=Atomics.load(E,S.OUT_TAIL);if(e===t)return[];let r=[],{newTail:o,messagesRead:C}=m({uint8View:y,dataView:P,bufferStart:T+n.OUT_BUFFER_START,bufferSize:n.OUT_BUFFER_SIZE,head:e,tail:t,messageMagic:n.MESSAGE_MAGIC,paddingMagic:n.PADDING_MAGIC,headerSize:n.MESSAGE_HEADER_SIZE,maxMessages:100,onMessage:(l,i,u)=>{if(O>=0){let c=O+1&4294967295;if(i!==c){let f=i-c+4294967296&4294967295;f<1e3&&(console.warn("[OSCInWorker] Detected",f,"dropped messages (expected seq",c,"got",i,")"),a&&Atomics.add(a,18,f))}}O=i,r.push({oscData:l,sequence:i}),a&&(Atomics.add(a,17,1),Atomics.add(a,19,l.length))},onCorruption:l=>{console.error("[OSCInWorker] Corrupted message at position",l),a&&Atomics.add(a,18,1)}});return C>0&&Atomics.store(E,S.OUT_TAIL,o),r},b=()=>{for(;R;)try{let e=Atomics.load(E,S.OUT_HEAD),t=Atomics.load(E,S.OUT_TAIL);if(e===t){let o=Atomics.wait(E,S.OUT_HEAD,e,100);if(!(o==="ok"||o==="not-equal")){if(o==="timed-out")continue}}let r=W();r.length>0&&self.postMessage({type:"messages",messages:r})}catch(e){console.error("[OSCInWorker] Error in wait loop:",e),self.postMessage({type:"error",error:e.message}),Atomics.wait(E,0,E[0],10)}},h=()=>{if(!_){console.error("[OSCInWorker] Cannot start - not initialized");return}if(R){console.warn("[OSCInWorker] Already running");return}R=!0,b()},Q=()=>{R=!1};self.addEventListener("message",e=>{let{data:t}=e;try{switch(t.type){case"init":k(t.sharedBuffer,t.ringBufferBase,t.bufferConstants),self.postMessage({type:"initialized"});break;case"start":h();break;case"stop":Q();break;default:console.warn("[OSCInWorker] Unknown message type:",t.type)}}catch(r){console.error("[OSCInWorker] Error:",r),self.postMessage({type:"error",error:r.message})}});H("[OSCInWorker] Script loaded");})();
