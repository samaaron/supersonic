var o={},o=o||{};(function(){"use strict";o.SECS_70YRS=2208988800,o.TWO_32=4294967296,o.defaults={metadata:!1,unpackSingleArgs:!0},o.isCommonJS=!!(typeof module<"u"&&module.exports),o.isNode=o.isCommonJS&&typeof window>"u",o.isElectron=!!(typeof process<"u"&&process.versions&&process.versions.electron),o.isBufferEnv=o.isNode||o.isElectron,o.isArray=function(i){return i&&Object.prototype.toString.call(i)==="[object Array]"},o.isTypedArrayView=function(i){return i.buffer&&i.buffer instanceof ArrayBuffer},o.isBuffer=function(i){return o.isBufferEnv&&i instanceof Buffer},o.Long=typeof Long<"u"?Long:void 0,o.TextDecoder=typeof TextDecoder<"u"?new TextDecoder("utf-8"):typeof util<"u"&&typeof(util.TextDecoder!=="undefined")?new util.TextDecoder("utf-8"):void 0,o.TextEncoder=typeof TextEncoder<"u"?new TextEncoder("utf-8"):typeof util<"u"&&typeof(util.TextEncoder!=="undefined")?new util.TextEncoder("utf-8"):void 0,o.dataView=function(i,e,t){return i.buffer?new DataView(i.buffer,e,t):i instanceof ArrayBuffer?new DataView(i,e,t):new DataView(new Uint8Array(i),e,t)},o.byteArray=function(i){if(i instanceof Uint8Array)return i;var e=i.buffer?i.buffer:i;if(!(e instanceof ArrayBuffer)&&(typeof e.length>"u"||typeof e=="string"))throw new Error("Can't wrap a non-array-like object as Uint8Array. Object was: "+JSON.stringify(i,null,2));return new Uint8Array(e)},o.nativeBuffer=function(i){return o.isBufferEnv?o.isBuffer(i)?i:Buffer.from(i.buffer?i:new Uint8Array(i)):o.isTypedArrayView(i)?i:new Uint8Array(i)},o.copyByteArray=function(i,e,t){if(o.isTypedArrayView(i)&&o.isTypedArrayView(e))e.set(i,t);else for(var r=t===void 0?0:t,s=Math.min(e.length-t,i.length),n=0,a=r;n<s;n++,a++)e[a]=i[n];return e},o.readString=function(i,e){for(var t=[],r=e.idx;r<i.byteLength;r++){var s=i.getUint8(r);if(s!==0)t.push(s);else{r++;break}}r=r+3&-4,e.idx=r;var n=o.isBufferEnv?o.readString.withBuffer:o.TextDecoder?o.readString.withTextDecoder:o.readString.raw;return n(t)},o.readString.raw=function(i){for(var e="",t=1e4,r=0;r<i.length;r+=t)e+=String.fromCharCode.apply(null,i.slice(r,r+t));return e},o.readString.withTextDecoder=function(i){var e=new Int8Array(i);return o.TextDecoder.decode(e)},o.readString.withBuffer=function(i){return Buffer.from(i).toString("utf-8")},o.writeString=function(i){var e=o.isBufferEnv?o.writeString.withBuffer:o.TextEncoder?o.writeString.withTextEncoder:null,t=i+"\0",r;e&&(r=e(t));for(var s=e?r.length:t.length,n=s+3&-4,a=new Uint8Array(n),c=0;c<s-1;c++){var l=e?r[c]:t.charCodeAt(c);a[c]=l}return a},o.writeString.withTextEncoder=function(i){return o.TextEncoder.encode(i)},o.writeString.withBuffer=function(i){return Buffer.from(i)},o.readPrimitive=function(i,e,t,r){var s=i[e](r.idx,!1);return r.idx+=t,s},o.writePrimitive=function(i,e,t,r,s){s=s===void 0?0:s;var n;return e?n=new Uint8Array(e.buffer):(n=new Uint8Array(r),e=new DataView(n.buffer)),e[t](s,i,!1),n},o.readInt32=function(i,e){return o.readPrimitive(i,"getInt32",4,e)},o.writeInt32=function(i,e,t){return o.writePrimitive(i,e,"setInt32",4,t)},o.readInt64=function(i,e){var t=o.readPrimitive(i,"getInt32",4,e),r=o.readPrimitive(i,"getInt32",4,e);return o.Long?new o.Long(r,t):{high:t,low:r,unsigned:!1}},o.writeInt64=function(i,e,t){var r=new Uint8Array(8);return r.set(o.writePrimitive(i.high,e,"setInt32",4,t),0),r.set(o.writePrimitive(i.low,e,"setInt32",4,t+4),4),r},o.readFloat32=function(i,e){return o.readPrimitive(i,"getFloat32",4,e)},o.writeFloat32=function(i,e,t){return o.writePrimitive(i,e,"setFloat32",4,t)},o.readFloat64=function(i,e){return o.readPrimitive(i,"getFloat64",8,e)},o.writeFloat64=function(i,e,t){return o.writePrimitive(i,e,"setFloat64",8,t)},o.readChar32=function(i,e){var t=o.readPrimitive(i,"getUint32",4,e);return String.fromCharCode(t)},o.writeChar32=function(i,e,t){var r=i.charCodeAt(0);if(!(r===void 0||r<-1))return o.writePrimitive(r,e,"setUint32",4,t)},o.readBlob=function(i,e){var t=o.readInt32(i,e),r=t+3&-4,s=new Uint8Array(i.buffer,e.idx,t);return e.idx+=r,s},o.writeBlob=function(i){i=o.byteArray(i);var e=i.byteLength,t=e+3&-4,r=4,s=t+r,n=new Uint8Array(s),a=new DataView(n.buffer);return o.writeInt32(e,a),n.set(i,r),n},o.readMIDIBytes=function(i,e){var t=new Uint8Array(i.buffer,e.idx,4);return e.idx+=4,t},o.writeMIDIBytes=function(i){i=o.byteArray(i);var e=new Uint8Array(4);return e.set(i),e},o.readColor=function(i,e){var t=new Uint8Array(i.buffer,e.idx,4),r=t[3]/255;return e.idx+=4,{r:t[0],g:t[1],b:t[2],a:r}},o.writeColor=function(i){var e=Math.round(i.a*255),t=new Uint8Array([i.r,i.g,i.b,e]);return t},o.readTrue=function(){return!0},o.readFalse=function(){return!1},o.readNull=function(){return null},o.readImpulse=function(){return 1},o.readTimeTag=function(i,e){var t=o.readPrimitive(i,"getUint32",4,e),r=o.readPrimitive(i,"getUint32",4,e),s=t===0&&r===1?Date.now():o.ntpToJSTime(t,r);return{raw:[t,r],native:s}},o.writeTimeTag=function(i){var e=i.raw?i.raw:o.jsToNTPTime(i.native),t=new Uint8Array(8),r=new DataView(t.buffer);return o.writeInt32(e[0],r,0),o.writeInt32(e[1],r,4),t},o.timeTag=function(i,e){i=i||0,e=e||Date.now();var t=e/1e3,r=Math.floor(t),s=t-r,n=Math.floor(i),a=i-n,c=s+a;if(c>1){var l=Math.floor(c),h=c-l;n+=l,c=h}var u=r+n+o.SECS_70YRS,f=Math.round(o.TWO_32*c);return{raw:[u,f]}},o.ntpToJSTime=function(i,e){var t=i-o.SECS_70YRS,r=e/o.TWO_32,s=(t+r)*1e3;return s},o.jsToNTPTime=function(i){var e=i/1e3,t=Math.floor(e),r=e-t,s=t+o.SECS_70YRS,n=Math.round(o.TWO_32*r);return[s,n]},o.readArguments=function(i,e,t){var r=o.readString(i,t);if(r.indexOf(",")!==0)throw new Error("A malformed type tag string was found while reading the arguments of an OSC message. String was: "+r," at offset: "+t.idx);var s=r.substring(1).split(""),n=[];return o.readArgumentsIntoArray(n,s,r,i,e,t),n},o.readArgument=function(i,e,t,r,s){var n=o.argumentTypes[i];if(!n)throw new Error("'"+i+"' is not a valid OSC type tag. Type tag string was: "+e);var a=n.reader,c=o[a](t,s);return r.metadata&&(c={type:i,value:c}),c},o.readArgumentsIntoArray=function(i,e,t,r,s,n){for(var a=0;a<e.length;){var c=e[a],l;if(c==="["){var h=e.slice(a+1),u=h.indexOf("]");if(u<0)throw new Error("Invalid argument type tag: an open array type tag ('[') was found without a matching close array tag ('[]'). Type tag was: "+t);var f=h.slice(0,u);l=o.readArgumentsIntoArray([],f,t,r,s,n),a+=u+2}else l=o.readArgument(c,t,r,s,n),a++;i.push(l)}return i},o.writeArguments=function(i,e){var t=o.collectArguments(i,e);return o.joinParts(t)},o.joinParts=function(i){for(var e=new Uint8Array(i.byteLength),t=i.parts,r=0,s=0;s<t.length;s++){var n=t[s];o.copyByteArray(n,e,r),r+=n.length}return e},o.addDataPart=function(i,e){e.parts.push(i),e.byteLength+=i.length},o.writeArrayArguments=function(i,e){for(var t="[",r=0;r<i.length;r++){var s=i[r];t+=o.writeArgument(s,e)}return t+="]",t},o.writeArgument=function(i,e){if(o.isArray(i))return o.writeArrayArguments(i,e);var t=i.type,r=o.argumentTypes[t].writer;if(r){var s=o[r](i.value);o.addDataPart(s,e)}return i.type},o.collectArguments=function(i,e,t){o.isArray(i)||(i=typeof i>"u"?[]:[i]),t=t||{byteLength:0,parts:[]},e.metadata||(i=o.annotateArguments(i));for(var r=",",s=t.parts.length,n=0;n<i.length;n++){var a=i[n];r+=o.writeArgument(a,t)}var c=o.writeString(r);return t.byteLength+=c.byteLength,t.parts.splice(s,0,c),t},o.readMessage=function(i,e,t){e=e||o.defaults;var r=o.dataView(i,i.byteOffset,i.byteLength);t=t||{idx:0};var s=o.readString(r,t);return o.readMessageContents(s,r,e,t)},o.readMessageContents=function(i,e,t,r){if(i.indexOf("/")!==0)throw new Error("A malformed OSC address was found while reading an OSC message. String was: "+i);var s=o.readArguments(e,t,r);return{address:i,args:s.length===1&&t.unpackSingleArgs?s[0]:s}},o.collectMessageParts=function(i,e,t){return t=t||{byteLength:0,parts:[]},o.addDataPart(o.writeString(i.address),t),o.collectArguments(i.args,e,t)},o.writeMessage=function(i,e){if(e=e||o.defaults,!o.isValidMessage(i))throw new Error("An OSC message must contain a valid address. Message was: "+JSON.stringify(i,null,2));var t=o.collectMessageParts(i,e);return o.joinParts(t)},o.isValidMessage=function(i){return i.address&&i.address.indexOf("/")===0},o.readBundle=function(i,e,t){return o.readPacket(i,e,t)},o.collectBundlePackets=function(i,e,t){t=t||{byteLength:0,parts:[]},o.addDataPart(o.writeString("#bundle"),t),o.addDataPart(o.writeTimeTag(i.timeTag),t);for(var r=0;r<i.packets.length;r++){var s=i.packets[r],n=s.address?o.collectMessageParts:o.collectBundlePackets,a=n(s,e);t.byteLength+=a.byteLength,o.addDataPart(o.writeInt32(a.byteLength),t),t.parts=t.parts.concat(a.parts)}return t},o.writeBundle=function(i,e){if(!o.isValidBundle(i))throw new Error("An OSC bundle must contain 'timeTag' and 'packets' properties. Bundle was: "+JSON.stringify(i,null,2));e=e||o.defaults;var t=o.collectBundlePackets(i,e);return o.joinParts(t)},o.isValidBundle=function(i){return i.timeTag!==void 0&&i.packets!==void 0},o.readBundleContents=function(i,e,t,r){for(var s=o.readTimeTag(i,t),n=[];t.idx<r;){var a=o.readInt32(i,t),c=t.idx+a,l=o.readPacket(i,e,t,c);n.push(l)}return{timeTag:s,packets:n}},o.readPacket=function(i,e,t,r){var s=o.dataView(i,i.byteOffset,i.byteLength);r=r===void 0?s.byteLength:r,t=t||{idx:0};var n=o.readString(s,t),a=n[0];if(a==="#")return o.readBundleContents(s,e,t,r);if(a==="/")return o.readMessageContents(n,s,e,t);throw new Error("The header of an OSC packet didn't contain an OSC address or a #bundle string. Header was: "+n)},o.writePacket=function(i,e){if(o.isValidMessage(i))return o.writeMessage(i,e);if(o.isValidBundle(i))return o.writeBundle(i,e);throw new Error("The specified packet was not recognized as a valid OSC message or bundle. Packet was: "+JSON.stringify(i,null,2))},o.argumentTypes={i:{reader:"readInt32",writer:"writeInt32"},h:{reader:"readInt64",writer:"writeInt64"},f:{reader:"readFloat32",writer:"writeFloat32"},s:{reader:"readString",writer:"writeString"},S:{reader:"readString",writer:"writeString"},b:{reader:"readBlob",writer:"writeBlob"},t:{reader:"readTimeTag",writer:"writeTimeTag"},T:{reader:"readTrue"},F:{reader:"readFalse"},N:{reader:"readNull"},I:{reader:"readImpulse"},d:{reader:"readFloat64",writer:"writeFloat64"},c:{reader:"readChar32",writer:"writeChar32"},r:{reader:"readColor",writer:"writeColor"},m:{reader:"readMIDIBytes",writer:"writeMIDIBytes"}},o.inferTypeForArgument=function(i){var e=typeof i;switch(e){case"boolean":return i?"T":"F";case"string":return"s";case"number":return"f";case"undefined":return"N";case"object":if(i===null)return"N";if(i instanceof Uint8Array||i instanceof ArrayBuffer)return"b";if(typeof i.high=="number"&&typeof i.low=="number")return"h";break}throw new Error("Can't infer OSC argument type for value: "+JSON.stringify(i,null,2))},o.annotateArguments=function(i){for(var e=[],t=0;t<i.length;t++){var r=i[t],s;if(typeof r=="object"&&r.type&&r.value!==void 0)s=r;else if(o.isArray(r))s=o.annotateArguments(r);else{var n=o.inferTypeForArgument(r);s={type:n,value:r}}e.push(s)}return e}})();var R=function(){};R.prototype.on=function(){};R.prototype.emit=function(){};R.prototype.removeListener=function(){};(function(){"use strict";o.supportsSerial=!1,o.firePacketEvents=function(e,t,r,s){t.address?e.emit("message",t,r,s):o.fireBundleEvents(e,t,r,s)},o.fireBundleEvents=function(e,t,r,s){e.emit("bundle",t,r,s);for(var n=0;n<t.packets.length;n++){var a=t.packets[n];o.firePacketEvents(e,a,t.timeTag,s)}},o.fireClosedPortSendError=function(e,t){t=t||"Can't send packets on a closed osc.Port object. Please open (or reopen) this Port by calling open().",e.emit("error",t)},o.Port=function(e){this.options=e||{},this.on("data",this.decodeOSC.bind(this))};var i=o.Port.prototype=Object.create(R.prototype);i.constructor=o.Port,i.send=function(e){var t=Array.prototype.slice.call(arguments),r=this.encodeOSC(e),s=o.nativeBuffer(r);t[0]=s,this.sendRaw.apply(this,t)},i.encodeOSC=function(e){e=e.buffer?e.buffer:e;var t;try{t=o.writePacket(e,this.options)}catch(r){this.emit("error",r)}return t},i.decodeOSC=function(e,t){e=o.byteArray(e),this.emit("raw",e,t);try{var r=o.readPacket(e,this.options);this.emit("osc",r,t),o.firePacketEvents(this,r,void 0,t)}catch(s){this.emit("error",s)}},o.SLIPPort=function(e){var t=this,r=this.options=e||{};r.useSLIP=r.useSLIP===void 0?!0:r.useSLIP,this.decoder=new slip.Decoder({onMessage:this.decodeOSC.bind(this),onError:function(n){t.emit("error",n)}});var s=r.useSLIP?this.decodeSLIPData:this.decodeOSC;this.on("data",s.bind(this))},i=o.SLIPPort.prototype=Object.create(o.Port.prototype),i.constructor=o.SLIPPort,i.encodeOSC=function(e){e=e.buffer?e.buffer:e;var t;try{var r=o.writePacket(e,this.options);t=slip.encode(r)}catch(s){this.emit("error",s)}return t},i.decodeSLIPData=function(e,t){this.decoder.decode(e,t)},o.relay=function(e,t,r,s,n,a){r=r||"message",s=s||"send",n=n||function(){},a=a?[null].concat(a):[];var c=function(l){a[0]=l,l=n(l),t[s].apply(t,a)};return e.on(r,c),{eventName:r,listener:c}},o.relayPorts=function(e,t,r){var s=r.raw?"raw":"osc",n=r.raw?"sendRaw":"send";return o.relay(e,t,s,n,r.transform)},o.stopRelaying=function(e,t){e.removeListener(t.eventName,t.listener)},o.Relay=function(e,t,r){var s=this.options=r||{};s.raw=!1,this.port1=e,this.port2=t,this.listen()},i=o.Relay.prototype=Object.create(R.prototype),i.constructor=o.Relay,i.open=function(){this.port1.open(),this.port2.open()},i.listen=function(){this.port1Spec&&this.port2Spec&&this.close(),this.port1Spec=o.relayPorts(this.port1,this.port2,this.options),this.port2Spec=o.relayPorts(this.port2,this.port1,this.options);var e=this.close.bind(this);this.port1.on("close",e),this.port2.on("close",e)},i.close=function(){o.stopRelaying(this.port1,this.port1Spec),o.stopRelaying(this.port2,this.port2Spec),this.emit("close",this.port1,this.port2)}})();(function(){"use strict";o.WebSocket=typeof WebSocket<"u"?WebSocket:void 0,o.WebSocketPort=function(e){o.Port.call(this,e),this.on("open",this.listen.bind(this)),this.socket=e.socket,this.socket&&(this.socket.readyState===1?(o.WebSocketPort.setupSocketForBinary(this.socket),this.emit("open",this.socket)):this.open())};var i=o.WebSocketPort.prototype=Object.create(o.Port.prototype);i.constructor=o.WebSocketPort,i.open=function(){(!this.socket||this.socket.readyState>1)&&(this.socket=new o.WebSocket(this.options.url)),o.WebSocketPort.setupSocketForBinary(this.socket);var e=this;this.socket.onopen=function(){e.emit("open",e.socket)},this.socket.onerror=function(t){e.emit("error",t)}},i.listen=function(){var e=this;this.socket.onmessage=function(t){e.emit("data",t.data,t)},this.socket.onclose=function(t){e.emit("close",t)},e.emit("ready")},i.sendRaw=function(e){if(!this.socket||this.socket.readyState!==1){o.fireClosedPortSendError(this);return}this.socket.send(e)},i.close=function(e,t){this.socket.close(e,t)},o.WebSocketPort.setupSocketForBinary=function(e){e.binaryType=o.isNode?"nodebuffer":"arraybuffer"}})();var O=o,{readPacket:et,writePacket:tt,readMessage:rt,writeMessage:st,readBundle:it,writeBundle:nt}=o;var D=class{constructor(e=null){this.workerBaseURL=e,this.workers={oscOut:null,oscIn:null,debug:null},this.callbacks={onRawOSC:null,onParsedOSC:null,onDebugMessage:null,onError:null,onInitialized:null},this.initialized=!1,this.sharedBuffer=null,this.ringBufferBase=null,this.bufferConstants=null}async init(e,t,r,s={}){if(this.initialized){console.warn("[ScsynthOSC] Already initialized");return}this.sharedBuffer=e,this.ringBufferBase=t,this.bufferConstants=r,this.preschedulerCapacity=s.preschedulerCapacity||65536;try{this.workers.oscOut=new Worker(this.workerBaseURL+"osc_out_prescheduler_worker.js",{type:"module"}),this.workers.oscIn=new Worker(this.workerBaseURL+"osc_in_worker.js",{type:"module"}),this.workers.debug=new Worker(this.workerBaseURL+"debug_worker.js",{type:"module"}),this.setupWorkerHandlers();let n=[this.initWorker(this.workers.oscOut,"OSC SCHEDULER+WRITER",{maxPendingMessages:this.preschedulerCapacity}),this.initWorker(this.workers.oscIn,"OSC IN"),this.initWorker(this.workers.debug,"DEBUG")];await Promise.all(n),this.workers.oscIn.postMessage({type:"start"}),this.workers.debug.postMessage({type:"start"}),this.initialized=!0,this.callbacks.onInitialized&&this.callbacks.onInitialized()}catch(n){throw console.error("[ScsynthOSC] Initialization failed:",n),this.callbacks.onError&&this.callbacks.onError(n),n}}initWorker(e,t,r={}){return new Promise((s,n)=>{let a=setTimeout(()=>{n(new Error(`${t} worker initialization timeout`))},5e3),c=l=>{l.data.type==="initialized"&&(clearTimeout(a),e.removeEventListener("message",c),s())};e.addEventListener("message",c),e.postMessage({type:"init",sharedBuffer:this.sharedBuffer,ringBufferBase:this.ringBufferBase,bufferConstants:this.bufferConstants,...r})})}setupWorkerHandlers(){this.workers.oscIn.onmessage=e=>{let t=e.data;switch(t.type){case"messages":t.messages.forEach(r=>{if(r.oscData&&(this.callbacks.onRawOSC&&this.callbacks.onRawOSC({oscData:r.oscData,sequence:r.sequence}),this.callbacks.onParsedOSC))try{let s={metadata:!1,unpackSingleArgs:!1},n=O.readPacket(r.oscData,s);this.callbacks.onParsedOSC(n)}catch(s){console.error("[ScsynthOSC] Failed to decode OSC message:",s,r)}});break;case"error":console.error("[ScsynthOSC] OSC IN error:",t.error),this.callbacks.onError&&this.callbacks.onError(t.error,"oscIn");break}},this.workers.debug.onmessage=e=>{let t=e.data;switch(t.type){case"debug":this.callbacks.onDebugMessage&&t.messages.forEach(r=>{this.callbacks.onDebugMessage(r)});break;case"error":console.error("[ScsynthOSC] DEBUG error:",t.error),this.callbacks.onError&&this.callbacks.onError(t.error,"debug");break}},this.workers.oscOut.onmessage=e=>{let t=e.data;switch(t.type){case"error":console.error("[ScsynthOSC] OSC OUT error:",t.error),this.callbacks.onError&&this.callbacks.onError(t.error,"oscOut");break}}}send(e,t={}){if(!this.initialized){console.error("[ScsynthOSC] Not initialized");return}let{editorId:r=0,runTag:s="",audioTimeS:n=null,currentTimeS:a=null}=t;this.workers.oscOut.postMessage({type:"send",oscData:e,editorId:r,runTag:s,audioTimeS:n,currentTimeS:a})}sendImmediate(e){if(!this.initialized){console.error("[ScsynthOSC] Not initialized");return}this.workers.oscOut.postMessage({type:"sendImmediate",oscData:e})}cancelEditorTag(e,t){this.initialized&&this.workers.oscOut.postMessage({type:"cancelEditorTag",editorId:e,runTag:t})}cancelEditor(e){this.initialized&&this.workers.oscOut.postMessage({type:"cancelEditor",editorId:e})}cancelTag(e){this.initialized&&this.workers.oscOut.postMessage({type:"cancelTag",runTag:e})}cancelAll(){this.initialized&&this.workers.oscOut.postMessage({type:"cancelAll"})}clearDebug(){this.initialized&&this.workers.debug.postMessage({type:"clear"})}onRawOSC(e){this.callbacks.onRawOSC=e}onParsedOSC(e){this.callbacks.onParsedOSC=e}onDebugMessage(e){this.callbacks.onDebugMessage=e}onError(e){this.callbacks.onError=e}onInitialized(e){this.callbacks.onInitialized=e}terminate(){this.workers.oscOut&&(this.workers.oscOut.postMessage({type:"stop"}),this.workers.oscOut.terminate()),this.workers.oscIn&&(this.workers.oscIn.postMessage({type:"stop"}),this.workers.oscIn.terminate()),this.workers.debug&&(this.workers.debug.postMessage({type:"stop"}),this.workers.debug.terminate()),this.workers={oscOut:null,oscIn:null,debug:null},this.initialized=!1}};var ge={5120:"i8",5121:"u8",5122:"i16",5123:"u16",5124:"i32",5125:"u32",5126:"f32"};var q={u8:1,u8c:1,i8:1,u16:2,i16:2,u32:4,i32:4,i64:8,u64:8,f32:4,f64:8};var ye={f32:Float32Array,f64:Float64Array},_e={i8:Int8Array,i16:Int16Array,i32:Int32Array},Ae={u8:Uint8Array,u8c:Uint8ClampedArray,u16:Uint16Array,u32:Uint32Array},be={i64:BigInt64Array,u64:BigUint64Array},Te={...ye,..._e,...Ae},Be=i=>{let e=ge[i];return e!==void 0?e:i};function Y(i,...e){let t=be[i];return new(t||Te[Be(i)])(...e)}var I=(i,e)=>(e--,i+e&~e);var Q=i=>typeof i=="number";var M=(i,e=t=>t!==void 0?": "+t:"")=>class extends Error{origMessage;constructor(t){super(i(t)+e(t)),this.origMessage=t!==void 0?String(t):""}};var Re=M(()=>"Assertion failed"),L=(typeof process<"u"&&process.env!==void 0?process.env.UMBRELLA_ASSERTS:!import.meta.env||import.meta.env.MODE!=="production"||import.meta.env.UMBRELLA_ASSERTS||import.meta.env.VITE_UMBRELLA_ASSERTS)?(i,e)=>{if(typeof i=="function"&&!i()||!i)throw new Re(typeof e=="function"?e():e)}:()=>{};var Oe=M(()=>"illegal argument(s)"),K=i=>{throw new Oe(i)};var X=0,j=1,J=2,ee=3,te=4,B=5,re=6,z=1,V=2,se=7*4,$=0,W=1,b=2*4,C=class{buf;start;u8;u32;state;constructor(e={}){if(this.buf=e.buf?e.buf:new ArrayBuffer(e.size||4096),this.start=e.start!=null?I(Math.max(e.start,0),4):0,this.u8=new Uint8Array(this.buf),this.u32=new Uint32Array(this.buf),this.state=new Uint32Array(this.buf,this.start,se/4),!e.skipInitialization){let t=e.align||8;L(t>=8,`invalid alignment: ${t}, must be a pow2 and >= 8`);let r=this.initialTop(t),s=e.end!=null?Math.min(e.end,this.buf.byteLength):this.buf.byteLength;r>=s&&K(`insufficient address range (0x${this.start.toString(16)} - 0x${s.toString(16)})`),this.align=t,this.doCompact=e.compact!==!1,this.doSplit=e.split!==!1,this.minSplit=e.minSplit||16,this.end=s,this.top=r,this._free=0,this._used=0}}stats(){let e=r=>{let s=0,n=0;for(;r;)s++,n+=this.blockSize(r),r=this.blockNext(r);return{count:s,size:n}},t=e(this._free);return{free:t,used:e(this._used),top:this.top,available:this.end-this.top+t.size,total:this.buf.byteLength}}callocAs(e,t,r=0){let s=this.mallocAs(e,t);return s?.fill(r),s}mallocAs(e,t){let r=this.malloc(t*q[e]);return r?Y(e,this.buf,r,t):void 0}calloc(e,t=0){let r=this.malloc(e);return r&&this.u8.fill(t,r,r+e),r}malloc(e){if(e<=0)return 0;let t=I(e+b,this.align),r=this.end,s=this.top,n=this._free,a=0;for(;n;){let c=this.blockSize(n),l=n+c>=s;if(l||c>=t)return this.mallocTop(n,a,c,t,l);a=n,n=this.blockNext(n)}return n=s,s=n+t,s<=r?(this.initBlock(n,t,this._used),this._used=n,this.top=s,U(n)):0}mallocTop(e,t,r,s,n){if(n&&e+s>this.end)return 0;if(t?this.unlinkBlock(t,e):this._free=this.blockNext(e),this.setBlockNext(e,this._used),this._used=e,n)this.top=e+this.setBlockSize(e,s);else if(this.doSplit){let a=r-s;a>=this.minSplit&&this.splitBlock(e,s,a)}return U(e)}realloc(e,t){if(t<=0)return 0;let r=H(e),s=0,n=this._used,a=0;for(;n;){if(n===r){[s,a]=this.reallocBlock(n,t);break}n=this.blockNext(n)}return s&&s!==r&&this.u8.copyWithin(U(s),U(r),a),U(s)}reallocBlock(e,t){let r=this.blockSize(e),s=e+r,n=s>=this.top,a=I(t+b,this.align);if(a<=r){if(this.doSplit){let c=r-a;c>=this.minSplit?this.splitBlock(e,a,c):n&&(this.top=e+a)}else n&&(this.top=e+a);return[e,s]}return n&&e+a<this.end?(this.top=e+this.setBlockSize(e,a),[e,s]):(this.free(e),[H(this.malloc(t)),s])}reallocArray(e,t){if(e.buffer!==this.buf)return;let r=this.realloc(e.byteOffset,t*e.BYTES_PER_ELEMENT);return r?new e.constructor(this.buf,r,t):void 0}free(e){let t;if(Q(e))t=e;else{if(e.buffer!==this.buf)return!1;t=e.byteOffset}t=H(t);let r=this._used,s=0;for(;r;){if(r===t)return s?this.unlinkBlock(s,r):this._used=this.blockNext(r),this.insert(r),this.doCompact&&this.compact(),!0;s=r,r=this.blockNext(r)}return!1}freeAll(){this._free=0,this._used=0,this.top=this.initialTop()}release(){return delete this.u8,delete this.u32,delete this.state,delete this.buf,!0}get align(){return this.state[te]}set align(e){this.state[te]=e}get end(){return this.state[ee]}set end(e){this.state[ee]=e}get top(){return this.state[J]}set top(e){this.state[J]=e}get _free(){return this.state[X]}set _free(e){this.state[X]=e}get _used(){return this.state[j]}set _used(e){this.state[j]=e}get doCompact(){return!!(this.state[B]&z)}set doCompact(e){e?this.state[B]|=1<<z-1:this.state[B]&=~z}get doSplit(){return!!(this.state[B]&V)}set doSplit(e){e?this.state[B]|=1<<V-1:this.state[B]&=~V}get minSplit(){return this.state[re]}set minSplit(e){L(e>b,`illegal min split threshold: ${e}, require at least ${b+1}`),this.state[re]=e}blockSize(e){return this.u32[(e>>2)+$]}setBlockSize(e,t){return this.u32[(e>>2)+$]=t,t}blockNext(e){return this.u32[(e>>2)+W]}setBlockNext(e,t){this.u32[(e>>2)+W]=t}initBlock(e,t,r){let s=e>>>2;return this.u32[s+$]=t,this.u32[s+W]=r,e}unlinkBlock(e,t){this.setBlockNext(e,this.blockNext(t))}splitBlock(e,t,r){this.insert(this.initBlock(e+this.setBlockSize(e,t),r,0)),this.doCompact&&this.compact()}initialTop(e=this.align){return I(this.start+se+b,e)-b}compact(){let e=this._free,t=0,r=0,s,n=!1;for(;e;){for(s=e,r=this.blockNext(e);r&&s+this.blockSize(s)===r;)s=r,r=this.blockNext(r);if(s!==e){let a=s-e+this.blockSize(s);this.setBlockSize(e,a);let c=this.blockNext(s),l=this.blockNext(e);for(;l&&l!==c;){let h=this.blockNext(l);this.setBlockNext(l,0),l=h}this.setBlockNext(e,c),n=!0}e+this.blockSize(e)>=this.top&&(this.top=e,t?this.unlinkBlock(t,e):this._free=this.blockNext(e)),t=e,e=this.blockNext(e)}return n}insert(e){let t=this._free,r=0;for(;t&&!(e<=t);)r=t,t=this.blockNext(t);r?this.setBlockNext(r,e):this._free=e,this.setBlockNext(e,t)}},U=i=>i>0?i+b:0,H=i=>i>0?i-b:0;var De=8,v=class{#r;#i;#s;#f;#t;#o;#e;#n;#h;constructor(e){let{audioContext:t,sharedBuffer:r,bufferPoolConfig:s,sampleBaseURL:n,maxBuffers:a=1024,assetLoader:c=null}=e;if(!t)throw new Error("BufferManager requires audioContext");if(!r||!(r instanceof SharedArrayBuffer))throw new Error("BufferManager requires sharedBuffer (SharedArrayBuffer)");if(!s||typeof s!="object")throw new Error("BufferManager requires bufferPoolConfig (object with start, size, align)");if(!Number.isFinite(s.start)||s.start<0)throw new Error("bufferPoolConfig.start must be a non-negative number");if(!Number.isFinite(s.size)||s.size<=0)throw new Error("bufferPoolConfig.size must be a positive number");if(!Number.isInteger(a)||a<=0)throw new Error("maxBuffers must be a positive integer");this.#s=t,this.#f=r,this.#r=n,this.#i=c,this.#t=new C({buf:r,start:s.start,size:s.size,align:De}),this.#o=s.size,this.#e=new Map,this.#n=new Map,this.#h=new Map,this.GUARD_BEFORE=3,this.GUARD_AFTER=1,this.MAX_BUFFERS=a;let l=(s.size/(1024*1024)).toFixed(0),h=(s.start/(1024*1024)).toFixed(0)}#w(e){if(typeof e!="string"||e.length===0)throw new Error("Invalid audio path: must be a non-empty string");if(e.includes(".."))throw new Error(`Invalid audio path: path cannot contain '..' (got: ${e})`);if(e.includes("%2e")||e.includes("%2E"))throw new Error(`Invalid audio path: path cannot contain URL-encoded characters (got: ${e})`);if(e.includes("\\"))throw new Error(`Invalid audio path: use forward slashes only (got: ${e})`);if(e.includes("://")||e.startsWith("/")||e.startsWith("./"))return e;if(!this.#r)throw new Error(`sampleBaseURL not configured. Please set it in SuperSonic constructor options.
Example: new SuperSonic({ sampleBaseURL: "./dist/samples/" })
Or use CDN: new SuperSonic({ sampleBaseURL: "https://unpkg.com/supersonic-scsynth-samples@latest/samples/" })
Or install: npm install supersonic-scsynth-samples`);return this.#r+e}#l(e){if(!Number.isInteger(e)||e<0||e>=this.MAX_BUFFERS)throw new Error(`Invalid buffer number ${e} (must be 0-${this.MAX_BUFFERS-1})`)}async#g(e,t,r){let s=null,n=null,a=!1,c=await this.#y(e),l=!1;try{await this.#m(e);let{ptr:h,sizeBytes:u,numFrames:f,numChannels:w,sampleRate:m,...S}=await r();s=h;let{uuid:p,allocationComplete:d}=this.#c(e,t);n=p,this.#p(e,s,u,p,d,{numFrames:f,numChannels:w,sampleRate:m}),a=!0;let E=this.#O(e,p,d);return c(),l=!0,{ptr:s,uuid:p,allocationComplete:E,numFrames:f,numChannels:w,sampleRate:m,...S}}catch(h){throw a&&n?this.#a(e,n,!1):s&&this.#t.free(s),h}finally{l||c()}}async prepareFromBlob(e){let{bufnum:t,blob:r,startFrame:s=0,numFrames:n=0,channels:a=null}=e;if(this.#l(t),!r||!(r instanceof ArrayBuffer||ArrayBuffer.isView(r)))throw new Error("/b_allocFile requires audio data as ArrayBuffer or typed array");let c=r instanceof ArrayBuffer?r:r.buffer.slice(r.byteOffset,r.byteOffset+r.byteLength);return this.#g(t,3e4,async()=>{let l=await this.#s.decodeAudioData(c),h=Math.max(0,Math.floor(s||0)),u=l.length-h,f=n&&n>0?Math.min(Math.floor(n),u):u;if(f<=0)throw new Error(`No audio frames available for buffer ${t}`);let w=this.#S(a,l.numberOfChannels),m=w.length,S=f*m+(this.GUARD_BEFORE+this.GUARD_AFTER)*m,p=this.#d(S),d=new Float32Array(S),E=this.GUARD_BEFORE*m;for(let y=0;y<f;y++)for(let g=0;g<m;g++){let A=w[g],T=l.getChannelData(A);d[E+y*m+g]=T[h+y]}this.#E(p,d);let _=d.length*4;return{ptr:p,sizeBytes:_,numFrames:f,numChannels:m,sampleRate:l.sampleRate}})}async prepareFromFile(e){let{bufnum:t,path:r,startFrame:s=0,numFrames:n=0,channels:a=null}=e;return this.#l(t),this.#g(t,6e4,async()=>{let c=this.#w(r),l=r.split("/").pop(),h=await this.#i.fetch(c,{type:"sample",name:l}),u=await this.#s.decodeAudioData(h),f=Math.max(0,Math.floor(s||0)),w=u.length-f,m=n&&n>0?Math.min(Math.floor(n),w):w;if(m<=0)throw new Error(`No audio frames available for buffer ${t} from ${r}`);let S=this.#S(a,u.numberOfChannels),p=S.length,d=m*p+(this.GUARD_BEFORE+this.GUARD_AFTER)*p,E=this.#d(d),_=new Float32Array(d),y=this.GUARD_BEFORE*p;for(let A=0;A<m;A++)for(let T=0;T<p;T++){let we=S[T],Ee=u.getChannelData(we);_[y+A*p+T]=Ee[f+A]}this.#E(E,_);let g=_.length*4;return{ptr:E,sizeBytes:g,numFrames:m,numChannels:p,sampleRate:u.sampleRate}})}async prepareEmpty(e){let{bufnum:t,numFrames:r,numChannels:s=1,sampleRate:n=null}=e;if(this.#l(t),!Number.isFinite(r)||r<=0)throw new Error(`/b_alloc requires a positive number of frames (got ${r})`);if(!Number.isFinite(s)||s<=0)throw new Error(`/b_alloc requires a positive channel count (got ${s})`);let a=Math.floor(r),c=Math.floor(s);return this.#g(t,5e3,async()=>{let l=a*c+(this.GUARD_BEFORE+this.GUARD_AFTER)*c,h=this.#d(l),u=new Float32Array(l);this.#E(h,u);let f=u.length*4;return{ptr:h,sizeBytes:f,numFrames:a,numChannels:c,sampleRate:n||this.#s.sampleRate}})}#S(e,t){return!e||e.length===0?Array.from({length:t},(r,s)=>s):(e.forEach(r=>{if(!Number.isInteger(r)||r<0||r>=t)throw new Error(`Channel ${r} is out of range (file has ${t} channels)`)}),e)}#d(e){let t=e*4,r=this.#t.malloc(t);if(r===0){let s=this.#t.stats(),n=((s.available||0)/(1024*1024)).toFixed(2),a=((s.total||0)/(1024*1024)).toFixed(2),c=(t/(1024*1024)).toFixed(2);throw new Error(`Buffer pool allocation failed: requested ${c}MB, available ${n}MB of ${a}MB total`)}return r}#E(e,t){new Float32Array(this.#f,e,t.length).set(t)}#_(e,t,r){return new Promise((s,n)=>{let a=setTimeout(()=>{this.#n.delete(e),n(new Error(`Buffer ${t} allocation timeout (${r}ms)`))},r);this.#n.set(e,{resolve:s,reject:n,timeout:a})})}#c(e,t){let r=crypto.randomUUID(),s=this.#_(r,e,t);return{uuid:r,allocationComplete:s}}async#y(e){let t=this.#h.get(e)||Promise.resolve(),r,s=new Promise(n=>{r=n});return this.#h.set(e,t.then(()=>s)),await t,()=>{r&&(r(),r=null),this.#h.get(e)===s&&this.#h.delete(e)}}#p(e,t,r,s,n,a={}){let c=this.#e.get(e),l={ptr:t,size:r,numFrames:a.numFrames||0,numChannels:a.numChannels||1,sampleRate:a.sampleRate||48e3,pendingToken:s,pendingPromise:n,previousAllocation:c?{ptr:c.ptr,size:c.size}:null};return this.#e.set(e,l),l}async#m(e){let t=this.#e.get(e);if(t&&t.pendingToken&&t.pendingPromise)try{await t.pendingPromise}catch{}}#O(e,t,r){return!r||typeof r.then!="function"?(this.#a(e,t,!0),Promise.resolve()):r.then(s=>(this.#a(e,t,!0),s)).catch(s=>{throw this.#a(e,t,!1),s})}#a(e,t,r){let s=this.#e.get(e);if(!s||s.pendingToken!==t)return;let n=s.previousAllocation;if(r){s.pendingToken=null,s.pendingPromise=null,s.previousAllocation=null,n?.ptr&&this.#t.free(n.ptr);return}s.ptr&&this.#t.free(s.ptr),s.pendingPromise=null,n?.ptr?this.#e.set(e,{ptr:n.ptr,size:n.size,pendingToken:null,previousAllocation:null}):this.#e.delete(e)}handleBufferFreed(e){let t=e[0],r=e[1],s=this.#e.get(t);if(!s){typeof r=="number"&&r!==0&&this.#t.free(r);return}if(typeof r=="number"&&r===s.ptr){this.#t.free(s.ptr),this.#e.delete(t);return}if(typeof r=="number"&&s.previousAllocation&&s.previousAllocation.ptr===r){this.#t.free(r),s.previousAllocation=null;return}this.#t.free(s.ptr),this.#e.delete(t)}handleBufferAllocated(e){let t=e[0],r=e[1],s=this.#n.get(t);s&&(clearTimeout(s.timeout),s.resolve({bufnum:r}),this.#n.delete(t))}allocate(e){let t=e*4,r=this.#t.malloc(t);if(r===0){let s=this.#t.stats(),n=((s.available||0)/(1024*1024)).toFixed(2),a=((s.total||0)/(1024*1024)).toFixed(2),c=(t/(1024*1024)).toFixed(2);console.error(`[BufferManager] Allocation failed: requested ${c}MB, available ${n}MB of ${a}MB total`)}return r}free(e){return this.#t.free(e)}getView(e,t){return new Float32Array(this.#f,e,t)}getStats(){return this.#t.stats()}getAllocatedBuffers(){let e=[];for(let[t,r]of this.#e.entries())!r||!r.ptr||e.push({bufnum:t,ptr:r.ptr,numFrames:r.numFrames,numChannels:r.numChannels,sampleRate:r.sampleRate});return e}updateAudioContext(e){if(!e)throw new Error("BufferManager.updateAudioContext requires audioContext");this.#s=e}getDiagnostics(){let e=this.#t.stats(),t=0,r=0;for(let s of this.#e.values())s&&(t+=s.size||0,s.pendingToken&&r++);return{active:this.#e.size,pending:r,bytesActive:t,pool:{total:this.#o,available:e.available||0,freeBytes:e.free?.size||0,freeBlocks:e.free?.count||0,usedBytes:e.used?.size||0,usedBlocks:e.used?.count||0}}}destroy(){for(let[e,t]of this.#n.entries())clearTimeout(t.timeout),t.reject(new Error("BufferManager destroyed"));this.#n.clear();for(let[e,t]of this.#e.entries())t.ptr&&this.#t.free(t.ptr);this.#e.clear(),this.#h.clear()}};var P=class{#r;#i;#s;constructor(e={}){let{onLoadingEvent:t=null,maxRetries:r=3,baseDelay:s=1e3}=e;this.#r=t,this.#i=r,this.#s=s}async fetch(e,{type:t,name:r}){let s=this.#f(e),n=this.#t(e),a=await s;this.#r?.("loading:start",{type:t,name:r,...a!=null&&{size:a}});let l=await(await n).arrayBuffer();return this.#r?.("loading:complete",{type:t,name:r,size:l.byteLength}),l}async#f(e){try{let t=await fetch(e,{method:"HEAD"});if(t.ok){let r=t.headers.get("Content-Length");return r?parseInt(r,10):null}return null}catch{return null}}async#t(e){let t;for(let r=0;r<=this.#i;r++)try{let s=await fetch(e);if(s.status>=400&&s.status<500)throw new Error(`Failed to fetch ${e}: ${s.status} ${s.statusText}`);if(!s.ok)throw new Error(`Server error fetching ${e}: ${s.status} ${s.statusText}`);return s}catch(s){if(t=s,s.message.includes("Failed to fetch")&&s.message.includes("4"))throw s;if(r<this.#i){let n=this.#s*Math.pow(2,r);await this.#o(n)}}throw t}#o(e){return new Promise(t=>setTimeout(t,e))}};var k=class{#r;#i;constructor({bufferManager:e,getDefaultSampleRate:t}){if(!e)throw new Error("OSCRewriter requires bufferManager");if(typeof t!="function")throw new Error("OSCRewriter requires getDefaultSampleRate callback");this.#r=e,this.#i=t}async rewritePacket(e){if(e&&e.address){let{message:t,changed:r}=await this.#s(e);return{packet:t,changed:r}}if(this.#h(e)){let t=await Promise.all(e.packets.map(n=>this.rewritePacket(n)));if(!t.some(n=>n.changed))return{packet:e,changed:!1};let s=t.map(n=>n.packet);return{packet:{timeTag:e.timeTag,packets:s},changed:!0}}return{packet:e,changed:!1}}async#s(e){switch(e.address){case"/b_alloc":return{message:await this.#f(e),changed:!0};case"/b_allocRead":return{message:await this.#t(e),changed:!0};case"/b_allocReadChannel":return{message:await this.#o(e),changed:!0};case"/b_allocFile":return{message:await this.#e(e),changed:!0};default:return{message:e,changed:!1}}}async#f(e){let t=this.#E(e.args,0,"/b_alloc requires a buffer number"),r=this.#E(e.args,1,"/b_alloc requires a frame count"),s=2,n=1,a=this.#i();this.#p(this.#S(e.args,s))&&(n=Math.max(1,this.#_(e.args,s,1)),s++),this.#S(e.args,s)?.type==="b"&&s++,this.#p(this.#S(e.args,s))&&(a=this.#d(this.#S(e.args,s)));let c=await this.#r.prepareEmpty({bufnum:t,numFrames:r,numChannels:n,sampleRate:a});return this.#m(c.allocationComplete,`/b_alloc ${t}`),this.#n(t,c)}async#t(e){let t=this.#E(e.args,0,"/b_allocRead requires a buffer number"),r=this.#c(e.args,1,"/b_allocRead requires a file path"),s=this.#_(e.args,2,0),n=this.#_(e.args,3,0),a=await this.#r.prepareFromFile({bufnum:t,path:r,startFrame:s,numFrames:n});return this.#m(a.allocationComplete,`/b_allocRead ${t}`),this.#n(t,a)}async#o(e){let t=this.#E(e.args,0,"/b_allocReadChannel requires a buffer number"),r=this.#c(e.args,1,"/b_allocReadChannel requires a file path"),s=this.#_(e.args,2,0),n=this.#_(e.args,3,0),a=[];for(let l=4;l<(e.args?.length||0)&&this.#p(e.args[l]);l++)a.push(Math.floor(this.#d(e.args[l])));let c=await this.#r.prepareFromFile({bufnum:t,path:r,startFrame:s,numFrames:n,channels:a.length>0?a:null});return this.#m(c.allocationComplete,`/b_allocReadChannel ${t}`),this.#n(t,c)}async#e(e){let t=this.#E(e.args,0,"/b_allocFile requires a buffer number"),r=this.#y(e.args,1,"/b_allocFile requires audio file data as blob"),s=await this.#r.prepareFromBlob({bufnum:t,blob:r});return this.#m(s.allocationComplete,`/b_allocFile ${t}`),this.#n(t,s)}#n(e,t){return{address:"/b_allocPtr",args:[this.#w(e),this.#w(t.ptr),this.#w(t.numFrames),this.#w(t.numChannels),this.#l(t.sampleRate),this.#g(t.uuid)]}}#h(e){return e&&e.timeTag!==void 0&&Array.isArray(e.packets)}#w(e){return{type:"i",value:Math.floor(e)}}#l(e){return{type:"f",value:e}}#g(e){return{type:"s",value:String(e)}}#S(e,t){if(Array.isArray(e))return e[t]}#d(e){if(e!=null)return typeof e=="object"&&Object.prototype.hasOwnProperty.call(e,"value")?e.value:e}#E(e,t,r){let s=this.#d(this.#S(e,t));if(!Number.isFinite(s))throw new Error(r);return Math.floor(s)}#_(e,t,r=0){let s=this.#d(this.#S(e,t));return Number.isFinite(s)?Math.floor(s):r}#c(e,t,r){let s=this.#d(this.#S(e,t));if(typeof s!="string")throw new Error(r);return s}#y(e,t,r){let s=this.#S(e,t);if(!s||s.type!=="b")throw new Error(r);let n=this.#d(s);if(!(n instanceof Uint8Array||n instanceof ArrayBuffer))throw new Error(r);return n}#p(e){if(!e)return!1;let t=this.#d(e);return Number.isFinite(t)}#m(e,t){!e||typeof e.catch!="function"||e.catch(r=>{console.error(`[OSCRewriter] ${t} allocation failed:`,r)})}};function Ie(i,e,t=0){for(let r=0;r<=t;r++)if(Atomics.compareExchange(i,e,0,1)===0)return!0;return!1}function Ue(i,e){Atomics.store(i,e,0)}function ie({atomicView:i,dataView:e,uint8View:t,bufferConstants:r,ringBufferBase:s,controlIndices:n,oscMessage:a,maxSpins:c=0}){let l=a.length,h=r.MESSAGE_HEADER_SIZE+l;if(h>r.IN_BUFFER_SIZE-r.MESSAGE_HEADER_SIZE||!Ie(i,n.IN_WRITE_LOCK,c))return!1;try{let u=Atomics.load(i,n.IN_HEAD),f=Atomics.load(i,n.IN_TAIL);if((r.IN_BUFFER_SIZE-1-u+f)%r.IN_BUFFER_SIZE<h)return!1;let m=Atomics.add(i,n.IN_SEQUENCE,1),S=r.IN_BUFFER_SIZE-u;if(h>S){let d=new Uint8Array(r.MESSAGE_HEADER_SIZE),E=new DataView(d.buffer);E.setUint32(0,r.MESSAGE_MAGIC,!0),E.setUint32(4,h,!0),E.setUint32(8,m,!0),E.setUint32(12,0,!0);let _=s+r.IN_BUFFER_START+u,y=s+r.IN_BUFFER_START;if(S>=r.MESSAGE_HEADER_SIZE){t.set(d,_);let g=S-r.MESSAGE_HEADER_SIZE;t.set(a.subarray(0,g),_+r.MESSAGE_HEADER_SIZE),t.set(a.subarray(g),y)}else{t.set(d.subarray(0,S),_),t.set(d.subarray(S),y);let g=r.MESSAGE_HEADER_SIZE-S;t.set(a,y+g)}}else{let d=s+r.IN_BUFFER_START+u;e.setUint32(d,r.MESSAGE_MAGIC,!0),e.setUint32(d+4,h,!0),e.setUint32(d+8,m,!0),e.setUint32(d+12,0,!0),t.set(a,d+r.MESSAGE_HEADER_SIZE)}Atomics.load(i,n.IN_HEAD);let p=(u+h)%r.IN_BUFFER_SIZE;return Atomics.store(i,n.IN_HEAD,p),!0}finally{Ue(i,n.IN_WRITE_LOCK)}}var Me=.2,x=class{#r;#i;#s;#f;#t;#o;#e;#n;#h;constructor({sharedBuffer:e,ringBufferBase:t,bufferConstants:r,getAudioContextTime:s,getNTPStartTime:n}){if(!e||!r)throw new Error("DirectWriter requires sharedBuffer and bufferConstants");if(typeof s!="function")throw new Error("DirectWriter requires getAudioContextTime callback");if(typeof n!="function")throw new Error("DirectWriter requires getNTPStartTime callback");this.#r=e,this.#i=t,this.#s=r,this.#f=s,this.#t=n,this.#w()}tryWrite(e){return!this.#o||!this.#h||!this.#l(e)?!1:ie({atomicView:this.#o,dataView:this.#e,uint8View:this.#n,bufferConstants:this.#s,ringBufferBase:this.#i,controlIndices:this.#h,oscMessage:e})}isBundle(e){return e.length>=8&&e[0]===35}#w(){this.#o=new Int32Array(this.#r),this.#e=new DataView(this.#r),this.#n=new Uint8Array(this.#r);let e=this.#s.CONTROL_START;this.#h={IN_HEAD:(this.#i+e+0)/4,IN_TAIL:(this.#i+e+4)/4,IN_SEQUENCE:(this.#i+e+24)/4,IN_WRITE_LOCK:(this.#i+e+40)/4}}#l(e){if(!this.isBundle(e)||e.length<16)return!0;let t=new DataView(e.buffer,e.byteOffset,e.byteLength),r=t.getUint32(8,!1),s=t.getUint32(12,!1);if(r===0&&(s===0||s===1))return!0;let n=this.#f(),a=this.#t();if(n===null||a===0)return!0;let c=n+a;return r+s/4294967296-c<Me}};function G(i){if(!i)return null;if(typeof i=="string")return(i.split("/").filter(Boolean).pop()||i).replace(/\.scsyndef$/i,"");let e=i instanceof ArrayBuffer?new Uint8Array(i):i;if(!(e instanceof Uint8Array)||e.length<11||e[0]!==83||e[1]!==67||e[2]!==103||e[3]!==102)return null;let t=e[10];if(t===0||11+t>e.length)return null;try{return new TextDecoder().decode(e.slice(11,11+t))}catch{return null}}function F(i){return i/1e3+2208988800}function Z(i,e){return i-e}function ne(i,e){let t=i-e;return Math.round(t*1e3)}var oe={totalPages:1280,ringBufferReserved:3145728,bufferPoolOffset:19922944,bufferPoolSize:63963136,get totalMemory(){return this.bufferPoolOffset+this.bufferPoolSize},get wasmHeapSize(){return this.bufferPoolOffset-this.ringBufferReserved}};var ae={numBuffers:1024,maxNodes:1024,maxGraphDefs:1024,maxWireBufs:64,numAudioBusChannels:128,numInputBusChannels:0,numOutputBusChannels:2,numControlBusChannels:4096,bufLength:128,realTimeMemorySize:8192,numRGens:64,realTime:!1,memoryLocking:!1,loadGraphDefs:0,preferredSampleRate:0,verbosity:0};var Se=class i{static osc={encode:e=>O.writePacket(e),decode:(e,t={metadata:!1})=>O.readPacket(e,t)};static inspect(e){let t,r,s;if(e instanceof i)t=e.sharedBuffer,r=e.ringBufferBase,s=e.bufferConstants;else if(e&&e.sab)t=e.sab,r=e.ringBufferBase??0,s=e.layout;else throw new Error("SuperSonic.inspect() requires an instance or {sab, ringBufferBase, layout}");if(!t||!s)return{error:"Not initialized - sab or layout missing"};let n=new Int32Array(t),a=r+s.CONTROL_START,c={inHead:Atomics.load(n,(a+0)/4),inTail:Atomics.load(n,(a+4)/4),outHead:Atomics.load(n,(a+8)/4),outTail:Atomics.load(n,(a+12)/4),debugHead:Atomics.load(n,(a+16)/4),debugTail:Atomics.load(n,(a+20)/4),inSequence:Atomics.load(n,(a+24)/4),outSequence:Atomics.load(n,(a+28)/4),debugSequence:Atomics.load(n,(a+32)/4),statusFlags:Atomics.load(n,(a+36)/4),inWriteLock:Atomics.load(n,(a+40)/4)},l=new Float64Array(t,r+s.NTP_START_TIME_START,1),h=new Int32Array(t,r+s.DRIFT_OFFSET_START,1),u=new Int32Array(t,r+s.GLOBAL_OFFSET_START,1),f={ntpStartTime:l[0],driftOffsetMs:Atomics.load(h,0),globalOffsetMs:Atomics.load(u,0)},w=(c.inHead-c.inTail+s.IN_BUFFER_SIZE)%s.IN_BUFFER_SIZE,m=(c.outHead-c.outTail+s.OUT_BUFFER_SIZE)%s.OUT_BUFFER_SIZE,S=(c.debugHead-c.debugTail+s.DEBUG_BUFFER_SIZE)%s.DEBUG_BUFFER_SIZE,p={in:{bytes:w,percent:w/s.IN_BUFFER_SIZE*100},out:{bytes:m,percent:m/s.OUT_BUFFER_SIZE*100},debug:{bytes:S,percent:S/s.DEBUG_BUFFER_SIZE*100}},d=new Uint32Array(t,r+s.METRICS_START,s.METRICS_SIZE/4),E={processCount:d[0],messagesProcessed:d[1],messagesDropped:d[2],schedulerQueueDepth:d[3],schedulerQueueMax:d[4],schedulerQueueDropped:d[5]};return{layout:s,ringBufferBase:r,control:c,timing:f,bufferUsage:p,metrics:E,sabByteLength:t.byteLength}}#r;#i;#s;#f;#t;#o;#e;#n;#h;#w;#l;#g;#S;#d;#E;#_;#c;#y;#p;#m;#O;#a;#I;#D;#A;#T;#B;#U;#M=null;#P=!1;#N=100;#b=new Map;#L=null;#C=null;constructor(e={}){if(this.#c=!1,this.#y=!1,this.#p=null,this.#m={},this.#O=null,this.#t=null,this.#o=null,this.#e=null,this.#r=null,this.#i=null,this.#s=null,this.#n=null,this.loadedSynthDefs=new Map,!e.workerBaseURL||!e.wasmBaseURL)throw new Error(`SuperSonic requires workerBaseURL and wasmBaseURL options. Example:
new SuperSonic({
  workerBaseURL: "/supersonic/workers/",
  wasmBaseURL: "/supersonic/wasm/"
})`);let t=e.workerBaseURL,r=e.wasmBaseURL,s={...ae,...e.scsynthOptions};this.#a={wasmUrl:e.wasmUrl||r+"scsynth-nrt.wasm",wasmBaseURL:r,workletUrl:e.workletUrl||t+"scsynth_audio_worklet.js",workerBaseURL:t,development:!1,audioContextOptions:{latencyHint:"interactive",sampleRate:48e3},memory:oe,worldOptions:s,preschedulerCapacity:e.preschedulerCapacity||65536,debugMaxLineLength:e.debugMaxLineLength??0},this.#S=e.sampleBaseURL||null,this.#d=e.synthdefBaseURL||null,this.#E={maxRetries:e.fetchMaxRetries??3,baseDelay:e.fetchRetryDelay??1e3},this.#_=new P({onLoadingEvent:(n,a)=>this.#u(n,a),maxRetries:this.#E.maxRetries,baseDelay:this.#E.baseDelay}),this.bootStats={initStartTime:null,initDuration:null}}get initialized(){return this.#c}get initializing(){return this.#y}on(e,t){if(typeof t!="function")throw new Error("Callback must be a function");return this.#b.has(e)||this.#b.set(e,new Set),this.#b.get(e).add(t),()=>this.off(e,t)}off(e,t){let r=this.#b.get(e);return r&&r.delete(t),this}once(e,t){let r=(...s)=>{this.off(e,r),t(...s)};return this.on(e,r)}removeAllListeners(e){return e===void 0?this.#b.clear():this.#b.delete(e),this}#u(e,...t){let r=this.#b.get(e);if(r)for(let s of r)try{s(...t)}catch(n){console.error(`[SuperSonic] Error in ${e} listener:`,n)}}async init(e={}){if(!this.#c)return this.#p?this.#p:(this.#p=this.#K(e),this.#p)}async#K(e){this.#a={...this.#a,...e,audioContextOptions:{...this.#a.audioContextOptions,...e.audioContextOptions||{}}},this.#y=!0,this.bootStats.initStartTime=performance.now();try{this.#te(),this.#re(),this.#z(),this.#se(),this.#V();let t=await this.#$();await this.#W(t),await this.#H(),this.#Z(),this.#x(),this.#G()}catch(t){throw this.#y=!1,this.#p=null,console.error("[SuperSonic] Initialization failed:",t),this.#u("error",t),t}}getMetrics(){return this.#q()}setMetricsInterval(e){this.#N=e,this.#x()}stopMetricsPolling(){this.#v()}async#X(){if(!this.#r||!this.#A)return!1;try{await this.#r.resume()}catch{}let e=this.#A[0];await new Promise(s=>setTimeout(s,200));let r=this.#A[0]>e;return r&&this.#Q(),r}async recover(){if(!this.#c)return!1;if(await this.#X())return!0;this.#u("recover:start");let e=await this.#j();return this.#u("recover:complete",{success:e}),e}async#j(){if(!this.#c)return!1;let e=new Map(this.loadedSynthDefs),t=this.#n?.getAllocatedBuffers()||[];await this.#J(),await this.#ee();for(let[r,s]of e)try{await this.send("/d_recv",s)}catch(n){console.error(`[SuperSonic] Failed to restore synthdef ${r}:`,n)}for(let r of t)try{let s=crypto.randomUUID();await this.send("/b_allocPtr",r.bufnum,r.ptr,r.numFrames,r.numChannels,r.sampleRate,s)}catch(s){console.error(`[SuperSonic] Failed to restore buffer ${r.bufnum}:`,s)}return!0}async#J(){this.#F(),this.#v(),this.#l?.clear(),this.#l=null,this.#s&&(this.#s.cancelAll(),this.#s.terminate(),this.#s=null),this.#i&&(this.#i.disconnect(),this.#i=null),this.#r&&(await this.#r.close(),this.#r=null),this.#c=!1,this.loadedSynthDefs.clear(),this.#p=null,this.#o=null,this.#e=null,this.#I=null,this.#D=null,this.#A=null,this.#T=null,this.#B=null,this.#U=null,this.#g=void 0}async#ee(){this.#y=!0,this.bootStats.initStartTime=performance.now();try{this.#z(),this.#n&&this.#n.updateAudioContext(this.#r),this.#V();let e=await this.#$();await this.#W(e),await this.#H(),this.#Z(),this.#x(),this.#G()}catch(e){throw this.#y=!1,this.#p=null,console.error("[SuperSonic] Partial init failed:",e),this.#u("error",e),e}}getTree(){if(!this.#c||!this.#t||!this.#e)return{nodeCount:0,version:0,nodes:[]};let e=this.#e,t=this.#o+e.NODE_TREE_START,r=new Uint32Array(this.#t,t,2),s=r[0],n=r[1],a=t+e.NODE_TREE_HEADER_SIZE,c=e.NODE_TREE_MAX_NODES,l=e.NODE_TREE_ENTRY_SIZE,h=e.NODE_TREE_DEF_NAME_SIZE,u=new DataView(this.#t,a,c*l),f=new TextDecoder("utf-8"),w=[],m=0;for(let S=0;S<c&&m<s;S++){let p=S*l,d=u.getInt32(p,!0);if(d===-1)continue;m++;let E=a+p+24,_=new Uint8Array(this.#t,E,h),y=new Uint8Array(h);y.set(_);let g=y.indexOf(0);g===-1&&(g=h);let A=f.decode(y.subarray(0,g));w.push({id:d,parentId:u.getInt32(p+4,!0),isGroup:u.getInt32(p+8,!0)===1,prevId:u.getInt32(p+12,!0),nextId:u.getInt32(p+16,!0),headId:u.getInt32(p+20,!0),defName:A})}return{nodeCount:s,version:n,nodes:w}}get bufferConstants(){return this.#e}get ringBufferBase(){return this.#o}get sharedBuffer(){return this.#t}startCapture(){if(!this.#c||!this.#t||!this.#e)throw new Error("SuperSonic not initialized");let e=this.#e,t=this.#o+e.AUDIO_CAPTURE_START,r=new Uint32Array(this.#t,t,4);Atomics.store(r,1,0),Atomics.store(r,0,1)}stopCapture(){if(!this.#c||!this.#t||!this.#e)throw new Error("SuperSonic not initialized");let e=this.#e,t=this.#o+e.AUDIO_CAPTURE_START,r=new Uint32Array(this.#t,t,4);Atomics.store(r,0,0);let s=Atomics.load(r,1),n=r[2],a=r[3],c=t+e.AUDIO_CAPTURE_HEADER_SIZE,l=new Float32Array(this.#t,c,s*a),h=new Float32Array(s),u=a>1?new Float32Array(s):null;for(let f=0;f<s;f++)h[f]=l[f*a],u&&(u[f]=l[f*a+1]);return{sampleRate:n,channels:a,frames:s,left:h,right:u}}isCaptureEnabled(){if(!this.#c||!this.#t||!this.#e)return!1;let e=this.#e,t=this.#o+e.AUDIO_CAPTURE_START,r=new Uint32Array(this.#t,t,1);return Atomics.load(r,0)===1}getCaptureFrames(){if(!this.#c||!this.#t||!this.#e)return 0;let e=this.#e,t=this.#o+e.AUDIO_CAPTURE_START,r=new Uint32Array(this.#t,t,2);return Atomics.load(r,1)}getMaxCaptureDuration(){if(!this.#e)return 0;let e=this.#e;return e.AUDIO_CAPTURE_FRAMES/(e.AUDIO_CAPTURE_SAMPLE_RATE||48e3)}async send(e,...t){if(this.#R("send OSC messages"),e==="/d_load"||e==="/d_loadDir")throw new Error(`${e} is not supported in SuperSonic (no filesystem). Use loadSynthDef() or send /d_recv with synthdef bytes instead.`);if(e==="/b_read"||e==="/b_readChannel")throw new Error(`${e} is not supported in SuperSonic (no filesystem). Use loadSample() to load audio into a buffer.`);if(e==="/b_write"||e==="/b_close")throw new Error(`${e} is not supported in SuperSonic (no filesystem). Writing audio files is not available in the browser.`);if(e==="/clearSched")throw new Error("/clearSched is not supported in SuperSonic. Bundle scheduling works differently in the browser AudioWorklet environment.");if(e==="/dumpOSC")throw new Error("/dumpOSC is not supported in SuperSonic. Use browser developer tools to inspect OSC messages.");if(e==="/error")throw new Error("/error is not supported in SuperSonic. Error notifications are always enabled.");if(e==="/d_recv"){let a=t[0];if(a instanceof Uint8Array||a instanceof ArrayBuffer){let c=a instanceof ArrayBuffer?new Uint8Array(a):a,l=G(c)||"unknown";this.loadedSynthDefs.set(l,c)}}if(e==="/d_free")for(let a of t)typeof a=="string"&&this.loadedSynthDefs.delete(a);else e==="/d_freeAll"&&this.loadedSynthDefs.clear();let r=t.map(a=>{if(typeof a=="string")return{type:"s",value:a};if(typeof a=="number")return{type:Number.isInteger(a)?"i":"f",value:a};if(a instanceof Uint8Array||a instanceof ArrayBuffer)return{type:"b",value:a instanceof ArrayBuffer?new Uint8Array(a):a};throw new Error(`Unsupported argument type: ${typeof a}`)}),s={address:e,args:r},n=i.osc.encode(s);return this.sendOSC(n)}async sendOSC(e,t={}){this.#R("send OSC data");let r=this.#pe(e),s=await this.#me(r);if(this.#k("mainMessagesSent"),this.#k("mainBytesSent",s.length),this.#u("message:sent",s),this.#I?.tryWrite(s)){this.#k("preschedulerBypassed");return}let n=this.#e?.scheduler_slot_size;if(n&&s.length>n)throw new Error(`OSC bundle too large to schedule (${s.length} > ${n} bytes). Use immediate timestamp (0 or 1) for large messages, or reduce bundle size.`);let a=this.#Se(s),c={...t};a&&(c.audioTimeS=a.audioTimeS,c.currentTimeS=a.currentTimeS),this.#s.send(s,c)}cancelTag(e){this.#R("cancel by tag"),this.#s.cancelTag(e)}cancelEditor(e){this.#R("cancel by editor"),this.#s.cancelEditor(e)}cancelEditorTag(e,t){this.#R("cancel by editor and tag"),this.#s.cancelEditorTag(e,t)}cancelAllScheduled(){this.#R("cancel all scheduled"),this.#s.cancelAll()}get audioContext(){return this.#r}get workletNode(){return this.#i}get osc(){return this.#s}async loadSynthDef(e){if(!this.#c)throw new Error("SuperSonic not initialized. Call init() first.");let t;if(this.#ue(e))t=e;else{if(!this.#d)throw new Error("synthdefBaseURL not configured. Either provide a full path or set synthdefBaseURL in constructor options.");t=`${this.#d}${e}.scsyndef`}let r=G(t);try{let s=await this.#_.fetch(t,{type:"synthdef",name:r}),n=new Uint8Array(s);return await this.send("/d_recv",n),{name:r,size:n.length}}catch(s){throw console.error("[SuperSonic] Failed to load synthdef:",s),s}}async loadSynthDefs(e){if(!this.#c)throw new Error("SuperSonic not initialized. Call init() first.");let t={};await Promise.all(e.map(async s=>{try{await this.loadSynthDef(s),t[s]={success:!0}}catch(n){console.error(`[SuperSonic] Failed to load ${s}:`,n),t[s]={success:!1,error:n.message}}}));let r=Object.values(t).filter(s=>s.success).length;return t}async loadSample(e,t,r=0,s=0){this.#R("load samples");let n=await this.#n.prepareFromFile({bufnum:e,path:t,startFrame:r,numFrames:s});return await this.send("/b_allocPtr",e,n.ptr,n.numFrames,n.numChannels,n.sampleRate,n.uuid),n.allocationComplete}async sync(e=Math.floor(Math.random()*2147483647)){if(!this.#c)throw new Error("SuperSonic not initialized. Call init() first.");let t=new Promise((r,s)=>{let n=setTimeout(()=>{this.#l&&this.#l.delete(e),s(new Error("Timeout waiting for /synced response"))},1e4),a=c=>{clearTimeout(n),this.#l.delete(e),r()};this.#l||(this.#l=new Map),this.#l.set(e,a)});await this.send("/sync",e),await t}getInfo(){return this.#R("get info"),{sampleRate:this.#r.sampleRate,numBuffers:this.#a.worldOptions.numBuffers,totalMemory:this.#a.memory.totalMemory,wasmHeapSize:this.#a.memory.wasmHeapSize,bufferPoolSize:this.#a.memory.bufferPoolSize,bootTimeMs:this.bootStats.initDuration,capabilities:{...this.#m},version:this.#O}}async shutdown(){!this.#c&&!this.#y||(this.#u("shutdown"),this.#F(),this.#v(),this.#l?.clear(),this.#l=null,this.#s&&(this.#s.cancelAll(),this.#s.terminate(),this.#s=null),this.#i&&(this.#i.disconnect(),this.#i=null),this.#r&&(await this.#r.close(),this.#r=null),this.#n&&(this.#n.destroy(),this.#n=null),this.#h=null,this.#I=null,this.#t=null,this.#c=!1,this.loadedSynthDefs.clear(),this.#p=null,this.#f=null,this.#o=null,this.#e=null,this.#D=null,this.#A=null,this.#T=null,this.#B=null,this.#U=null,this.#g=void 0,this.bootStats={initStartTime:null,initDuration:null})}async destroy(){this.#u("destroy"),await this.shutdown(),this.#C=null,this.#b.clear()}async reset(e={}){await this.shutdown(),await this.init(e)}#te(){this.#m={audioWorklet:typeof AudioWorklet<"u",sharedArrayBuffer:typeof SharedArrayBuffer<"u",crossOriginIsolated:window.crossOriginIsolated===!0,atomics:typeof Atomics<"u",webWorker:typeof Worker<"u"};let t=["audioWorklet","sharedArrayBuffer","crossOriginIsolated","atomics","webWorker"].filter(r=>!this.#m[r]);if(t.length>0){let r=new Error(`Missing required features: ${t.join(", ")}`);throw this.#m.crossOriginIsolated||(this.#m.sharedArrayBuffer?r.message+=`

SharedArrayBuffer is available but cross-origin isolation is not enabled. Please ensure COOP and COEP headers are set correctly:
  Cross-Origin-Opener-Policy: same-origin
  Cross-Origin-Embedder-Policy: require-corp`:r.message+=`

SharedArrayBuffer is not available. This may be due to:
1. Missing COOP/COEP headers
2. Browser doesn't support SharedArrayBuffer
3. Browser security settings`),r}return this.#m}#re(){let e=this.#a.memory;this.#f=new WebAssembly.Memory({initial:e.totalPages,maximum:e.totalPages,shared:!0}),this.#t=this.#f.buffer}#z(){return this.#r=new AudioContext(this.#a.audioContextOptions),this.#r.addEventListener("statechange",()=>{let e=this.#r?.state;if(!e)return;let t=this.#L;this.#L=e,e==="running"&&(t==="suspended"||t==="interrupted")&&this.#Q(),this.#u("audiocontext:statechange",{state:e}),e==="suspended"?this.#u("audiocontext:suspended"):e==="running"?this.#u("audiocontext:resumed"):e==="interrupted"&&this.#u("audiocontext:interrupted")}),this.#r}#se(){this.#n=new v({audioContext:this.#r,sharedBuffer:this.#t,bufferPoolConfig:{start:this.#a.memory.bufferPoolOffset,size:this.#a.memory.bufferPoolSize},sampleBaseURL:this.#S,maxBuffers:this.#a.worldOptions.numBuffers,assetLoader:this.#_})}#V(){this.#h=new k({bufferManager:this.#n,getDefaultSampleRate:()=>this.#r?.sampleRate||44100})}async#ie(){let e=this.#a.wasmBaseURL+"manifest.json";try{let t=await fetch(e);if(!t.ok)return;let r=await t.json();this.#a.wasmUrl=this.#a.wasmBaseURL+r.wasmFile}catch{}}async#$(){if(this.#C)return this.#C;this.#a.development&&await this.#ie();let e=this.#a.wasmUrl.split("/").pop();this.#u("loading:start",{type:"wasm",name:e});let t;try{t=await fetch(this.#a.wasmUrl)}catch(s){throw new Error(`Failed to fetch WASM from ${this.#a.wasmUrl}: ${s.message}`)}if(!t.ok)throw new Error(`Failed to load WASM: ${t.status} ${t.statusText}`);let r=await t.arrayBuffer();return this.#u("loading:complete",{type:"wasm",name:e,size:r.byteLength}),this.#C=r,r}async#W(e){await this.#r.audioWorklet.addModule(this.#a.workletUrl),this.#i=new AudioWorkletNode(this.#r,"scsynth-processor",{numberOfInputs:0,numberOfOutputs:1,outputChannelCount:[2]}),this.#i.connect(this.#r.destination),this.#i.port.postMessage({type:"init",sharedBuffer:this.#t}),this.#i.port.postMessage({type:"loadWasm",wasmBytes:e,wasmMemory:this.#f,worldOptions:this.#a.worldOptions,sampleRate:this.#r.sampleRate}),await this.#ne()}async#H(){this.#s=new D(this.#a.workerBaseURL),this.#s.onRawOSC(e=>{this.#u("message:raw",e)}),this.#s.onParsedOSC(e=>{if(e.address==="/supersonic/buffer/freed")this.#n?.handleBufferFreed(e.args);else if(e.address==="/supersonic/buffer/allocated")this.#n?.handleBufferAllocated(e.args);else if(e.address==="/supersonic/synthdef/loaded"){let t=e.args[0]}else if(e.address==="/synced"&&e.args.length>0){let t=e.args[0];this.#l&&this.#l.has(t)&&this.#l.get(t)(e)}this.#u("message",e)}),this.#s.onDebugMessage(e=>{let t=this.#a.debugMaxLineLength;t>0&&e.text&&e.text.length>t&&(e={...e,text:e.text.slice(0,t)+"..."}),this.#u("debug",e)}),this.#s.onError((e,t)=>{console.error(`[SuperSonic] ${t} error:`,e),this.#u("error",new Error(`${t}: ${e}`))}),await this.#s.init(this.#t,this.#o,this.#e,{preschedulerCapacity:this.#a.preschedulerCapacity})}#G(){this.#c=!0,this.#y=!1,this.bootStats.initDuration=performance.now()-this.bootStats.initStartTime,this.#u("ready",{capabilities:this.#m,bootStats:this.bootStats})}#ne(){return new Promise((e,t)=>{let r=setTimeout(()=>{t(new Error("AudioWorklet initialization timeout"))},5e3),s=async n=>{if(n.data.type!=="debug"){if(n.data.type==="error"){console.error("[AudioWorklet] Error:",n.data.error),clearTimeout(r),this.#i.port.removeEventListener("message",s),t(new Error(n.data.error||"AudioWorklet error"));return}n.data.type==="initialized"&&(clearTimeout(r),this.#i.port.removeEventListener("message",s),n.data.success?(n.data.ringBufferBase!==void 0?this.#o=n.data.ringBufferBase:console.warn("[SuperSonic] Warning: ringBufferBase not provided by worklet"),n.data.bufferConstants!==void 0?(this.#e=n.data.bufferConstants,this.#ce(),this.#le(),await this.#he(),this.#de()):console.warn("[SuperSonic] Warning: bufferConstants not provided by worklet"),e()):t(new Error(n.data.error||"AudioWorklet initialization failed")))}};this.#i.port.addEventListener("message",s),this.#i.port.start()})}#Z(){this.#i.port.onmessage=e=>{let{data:t}=e;switch(t.type){case"error":console.error("[Worklet] Error:",t.error),t.diagnostics&&(console.error("[Worklet] Diagnostics:",t.diagnostics),console.table(t.diagnostics)),this.#u("error",new Error(t.error));break;case"process_debug":break;case"debug":break;case"version":this.#O=t.version;break}}}#oe(){if(!this.#A)return null;let e=this.#A;return{workletProcessCount:e[0],workletMessagesProcessed:e[1],workletMessagesDropped:e[2],workletSchedulerDepth:e[3],workletSchedulerMax:e[4],workletSchedulerDropped:e[5],workletSequenceGaps:e[24],preschedulerPending:e[6],preschedulerPeak:e[7],preschedulerSent:e[8],preschedulerRetriesSucceeded:e[9],preschedulerRetriesFailed:e[10],preschedulerBundlesScheduled:e[11],preschedulerEventsCancelled:e[12],preschedulerTotalDispatches:e[13],preschedulerMessagesRetried:e[14],preschedulerRetryQueueSize:e[15],preschedulerRetryQueueMax:e[16],preschedulerBypassed:e[25],oscInMessagesReceived:e[17],oscInMessagesDropped:e[18],oscInBytesReceived:e[19],debugMessagesReceived:e[20],debugBytesReceived:e[21],mainMessagesSent:e[22],mainBytesSent:e[23]}}#ae(){if(!this.#D||!this.#e||!this.#o)return null;let e=this.#o+this.#e.CONTROL_START,t=this.#D,r=Atomics.load(t,(e+0)/4),s=Atomics.load(t,(e+4)/4),n=Atomics.load(t,(e+8)/4),a=Atomics.load(t,(e+12)/4),c=Atomics.load(t,(e+16)/4),l=Atomics.load(t,(e+20)/4),h=(r-s+this.#e.IN_BUFFER_SIZE)%this.#e.IN_BUFFER_SIZE,u=(n-a+this.#e.OUT_BUFFER_SIZE)%this.#e.OUT_BUFFER_SIZE,f=(c-l+this.#e.DEBUG_BUFFER_SIZE)%this.#e.DEBUG_BUFFER_SIZE;return{inBufferUsed:{bytes:h,percentage:h/this.#e.IN_BUFFER_SIZE*100},outBufferUsed:{bytes:u,percentage:u/this.#e.OUT_BUFFER_SIZE*100},debugBufferUsed:{bytes:f,percentage:f/this.#e.DEBUG_BUFFER_SIZE*100}}}#k(e,t=1){if(!this.#A)return;let r={mainMessagesSent:22,mainBytesSent:23,preschedulerBypassed:25};Atomics.add(this.#A,r[e],t)}#q(){let e=performance.now(),t=this.#oe()||{},r=this.#ae();if(r&&Object.assign(t,r),t.driftOffsetMs=this.#fe(),t.audioContextState=this.#r?.state||"unknown",this.#n){let n=this.#n.getStats();t.bufferPoolUsedBytes=n.used.size,t.bufferPoolAvailableBytes=n.available,t.bufferPoolAllocations=n.used.count}t.loadedSynthDefs=this.loadedSynthDefs?.size||0;let s=performance.now()-e;return s>1&&console.warn(`[SuperSonic] Slow metrics gathering: ${s.toFixed(2)}ms`),t}#x(){this.#v();let e=this.#N;this.#M=setInterval(()=>{if(!(!this.#b.has("metrics")||this.#b.get("metrics").size===0)){if(this.#P){console.warn(`[SuperSonic] Metrics gathering took >${e}ms, skipping this interval`);return}this.#P=!0;try{let t=this.#q();this.#u("metrics",t)}catch(t){console.error("[SuperSonic] Metrics gathering failed:",t)}finally{this.#P=!1}}},e)}#v(){this.#M&&(clearInterval(this.#M),this.#M=null)}#R(e="perform this operation"){if(!this.#c)throw new Error(`SuperSonic not initialized. Call init() before attempting to ${e}.`)}#ce(){if(!this.#t||!this.#o||!this.#e){console.warn("[SuperSonic] Cannot initialize shared views - missing buffer info");return}this.#D=new Int32Array(this.#t);let e=this.#o+this.#e.METRICS_START;this.#A=new Uint32Array(this.#t,e,this.#e.METRICS_SIZE/4),this.#T=new Float64Array(this.#t,this.#o+this.#e.NTP_START_TIME_START,1),this.#B=new Int32Array(this.#t,this.#o+this.#e.DRIFT_OFFSET_START,1),this.#U=new Int32Array(this.#t,this.#o+this.#e.GLOBAL_OFFSET_START,1)}#le(){this.#I=new x({sharedBuffer:this.#t,ringBufferBase:this.#o,bufferConstants:this.#e,getAudioContextTime:()=>this.#r?.currentTime??null,getNTPStartTime:()=>this.#T?.[0]??0})}#ue(e){return e.includes("/")||e.includes("://")}#we(){return this.#n?.getStats()}async#he(){if(!this.#e||!this.#r)return;let e;for(;e=this.#r.getOutputTimestamp(),!(e.contextTime>0);)await new Promise(n=>setTimeout(n,50));let t=performance.timeOrigin+e.performanceTime,r=F(t),s=Z(r,e.contextTime);this.#T[0]=s,this.#g=s}#Y(){if(!this.#e||!this.#r||this.#g===void 0)return;let e=this.#r.getOutputTimestamp(),t=performance.timeOrigin+e.performanceTime,s=F(t)-this.#g,n=ne(s,e.contextTime);Atomics.store(this.#B,0,n)}#fe(){return this.#B?Atomics.load(this.#B,0):0}#Q(){if(!this.#r||!this.#T||!this.#B)return;let e=this.#r.getOutputTimestamp();if(!e||e.contextTime<=0)return;let t=performance.timeOrigin+e.performanceTime,r=F(t),s=Z(r,e.contextTime);this.#T[0]=s,this.#g=s,this.#Y()}#de(){this.#F(),this.#w=setInterval(()=>{this.#Y()},15e3)}#F(){this.#w&&(clearInterval(this.#w),this.#w=null)}#pe(e){if(e instanceof Uint8Array)return e;if(e instanceof ArrayBuffer)return new Uint8Array(e);throw new Error("oscData must be ArrayBuffer or Uint8Array")}async#me(e){let t={metadata:!0,unpackSingleArgs:!1};try{let r=i.osc.decode(e,t),{packet:s,changed:n}=await this.#h.rewritePacket(r);return n?i.osc.encode(s):e}catch(r){throw console.error("[SuperSonic] Failed to prepare OSC packet:",r),r}}#Se(e){if(e.length<16||String.fromCharCode.apply(null,e.slice(0,8))!=="#bundle\0")return null;let r=this.#T[0];if(r===0)return console.warn("[SuperSonic] NTP start time not yet initialized"),null;let n=Atomics.load(this.#B,0)/1e3,c=Atomics.load(this.#U,0)/1e3,l=r+n+c,h=new DataView(e.buffer,e.byteOffset),u=h.getUint32(8,!1),f=h.getUint32(12,!1);if(u===0&&(f===0||f===1))return null;let m=u+f/4294967296-l,S=this.#r.currentTime;return{audioTimeS:m,currentTimeS:S}}};export{Se as SuperSonic};
/*! osc.js 2.4.5, Copyright 2024 Colin Clark | github.com/colinbdclark/osc.js */
