(()=>{function J(e,t,s=0){for(let r=0;r<=s;r++)if(Atomics.compareExchange(e,t,0,1)===0)return!0;return!1}function ee(e,t){Atomics.store(e,t,0)}function L({atomicView:e,dataView:t,uint8View:s,bufferConstants:r,ringBufferBase:c,controlIndices:i,oscMessage:u,maxSpins:P=0}){let x=u.length,_=r.MESSAGE_HEADER_SIZE+x;if(_>r.IN_BUFFER_SIZE-r.MESSAGE_HEADER_SIZE||!J(e,i.IN_WRITE_LOCK,P))return!1;try{let p=Atomics.load(e,i.IN_HEAD),X=Atomics.load(e,i.IN_TAIL);if((r.IN_BUFFER_SIZE-1-p+X)%r.IN_BUFFER_SIZE<_)return!1;let y=Atomics.add(e,i.IN_SEQUENCE,1),g=r.IN_BUFFER_SIZE-p;if(_>g){let a=new Uint8Array(r.MESSAGE_HEADER_SIZE),h=new DataView(a.buffer);h.setUint32(0,r.MESSAGE_MAGIC,!0),h.setUint32(4,_,!0),h.setUint32(8,y,!0),h.setUint32(12,0,!0);let D=c+r.IN_BUFFER_START+p,U=c+r.IN_BUFFER_START;if(g>=r.MESSAGE_HEADER_SIZE){s.set(a,D);let R=g-r.MESSAGE_HEADER_SIZE;s.set(u.subarray(0,R),D+r.MESSAGE_HEADER_SIZE),s.set(u.subarray(R),U)}else{s.set(a.subarray(0,g),D),s.set(a.subarray(g),U);let R=r.MESSAGE_HEADER_SIZE-g;s.set(u,U+R)}}else{let a=c+r.IN_BUFFER_START+p;t.setUint32(a,r.MESSAGE_MAGIC,!0),t.setUint32(a+4,_,!0),t.setUint32(a+8,y,!0),t.setUint32(a+12,0,!0),s.set(u,a+r.MESSAGE_HEADER_SIZE)}Atomics.load(e,i.IN_HEAD);let $=(p+_)%r.IN_BUFFER_SIZE;return Atomics.store(e,i.IN_HEAD,$),!0}finally{ee(e,i.IN_WRITE_LOCK)}}var f=null,d=null,l=null,N=null,b=null,Q=null,v={},o=null,n=[],q=null,ce=0,H=!1,E=[],G=5,A=65536,ie=2208988800,z=25,Ee=.2,S=(...e)=>{},Y=()=>(performance.timeOrigin+performance.now())/1e3+ie,le=e=>{if(e.length>=16&&e[0]===35){let t=new DataView(e.buffer,e.byteOffset),s=t.getUint32(8,!1),r=t.getUint32(12,!1);return s+r/4294967296}return null};var Se=()=>{if(!f||!l){console.error("[PreScheduler] Cannot init - missing buffer or constants");return}N=new Int32Array(f),b=new DataView(f),Q=new Uint8Array(f),v={IN_HEAD:(d+l.CONTROL_START+0)/4,IN_TAIL:(d+l.CONTROL_START+4)/4,IN_SEQUENCE:(d+l.CONTROL_START+24)/4,IN_WRITE_LOCK:(d+l.CONTROL_START+40)/4};let e=d+l.METRICS_START;o=new Uint32Array(f,e,l.METRICS_SIZE/4),S("[PreScheduler] SharedArrayBuffer initialized with direct ring buffer writing and metrics")},I=()=>{if(!o)return;Atomics.store(o,6,n.length);let e=n.length,t=Atomics.load(o,7);e>t&&Atomics.store(o,7,e)},T=(e,t)=>{if(!f||!N)return console.error("[PreScheduler] Not initialized for ring buffer writing"),!1;let s=e.length,r=l.MESSAGE_HEADER_SIZE+s;return r>l.IN_BUFFER_SIZE-l.MESSAGE_HEADER_SIZE?(console.error("[PreScheduler] Message too large:",r),!1):L({atomicView:N,dataView:b,uint8View:Q,bufferConstants:l,ringBufferBase:d,controlIndices:v,oscMessage:e,maxSpins:10})?(o&&Atomics.add(o,8,1),!0):(t||console.warn("[PreScheduler] Ring buffer full, message will be queued for retry"),!1)},m=(e,t)=>{let s=n.length+E.length;if(s>=A){console.error("[PreScheduler] Backpressure: dropping retry ("+s+" pending)"),o&&Atomics.add(o,10,1);return}if(E.push({oscData:e,retryCount:0,context:t||"unknown",queuedAt:performance.now()}),o){Atomics.store(o,15,E.length);let r=Atomics.load(o,16);E.length>r&&Atomics.store(o,16,E.length)}S("[PreScheduler] Queued message for retry:",t,"queue size:",E.length)},ae=()=>{if(E.length===0)return;let e=0;for(;e<E.length;){let t=E[e];if(T(t.oscData,!0))E.splice(e,1),o&&(Atomics.add(o,9,1),Atomics.add(o,14,1),Atomics.store(o,15,E.length)),S("[PreScheduler] Retry succeeded for:",t.context,"after",t.retryCount+1,"attempts");else if(t.retryCount++,o&&Atomics.add(o,14,1),t.retryCount>=G){let r=`Ring buffer full - dropped message after ${G} retries (${t.context})`;console.error("[PreScheduler]",r),E.splice(e,1),o&&(Atomics.add(o,10,1),Atomics.store(o,15,E.length)),self.postMessage({type:"error",error:r})}else e++}},ue=(e,t,s)=>{let r=n.length+E.length;if(r>=A)return console.warn("[PreScheduler] Backpressure: rejecting message ("+r+" pending)"),!1;let c=le(e);if(c===null)return S("[PreScheduler] Non-bundle message, dispatching immediately"),T(e,!1)||m(e,"immediate message"),!0;let i=Y(),u=c-i,P={ntpTime:c,seq:ce++,editorId:t||0,runTag:s||"",oscData:e};return fe(P),o&&Atomics.add(o,11,1),I(),S("[PreScheduler] Scheduled bundle:","NTP="+c.toFixed(3),"current="+i.toFixed(3),"wait="+(u*1e3).toFixed(1)+"ms","pending="+n.length),!0},fe=e=>{n.push(e),ge(n.length-1)},de=()=>n.length>0?n[0]:null,_e=()=>{if(n.length===0)return null;let e=n[0],t=n.pop();return n.length>0&&(n[0]=t,W(0)),e},ge=e=>{for(;e>0;){let t=Math.floor((e-1)/2);if(O(n[e],n[t])>=0)break;K(e,t),e=t}},W=e=>{let t=n.length;for(;;){let s=2*e+1,r=2*e+2,c=e;if(s<t&&O(n[s],n[c])<0&&(c=s),r<t&&O(n[r],n[c])<0&&(c=r),c===e)break;K(e,c),e=c}},O=(e,t)=>e.ntpTime===t.ntpTime?e.seq-t.seq:e.ntpTime-t.ntpTime,K=(e,t)=>{let s=n[e];n[e]=n[t],n[t]=s},pe=()=>{if(q!==null){console.warn("[PreScheduler] Polling already started");return}S("[PreScheduler] Starting periodic polling (every "+z+"ms)"),V()};var V=()=>{H=!0,ae();let e=Y(),t=e+Ee,s=0;for(;n.length>0;){let r=de();if(r.ntpTime<=t){_e(),I();let c=r.ntpTime-e;o&&Atomics.add(o,13,1),S("[PreScheduler] Dispatching bundle:","NTP="+r.ntpTime.toFixed(3),"current="+e.toFixed(3),"early="+(c*1e3).toFixed(1)+"ms","remaining="+n.length),T(r.oscData,!1)||m(r.oscData,"scheduled bundle NTP="+r.ntpTime.toFixed(3)),s++}else break}(s>0||n.length>0||E.length>0)&&S("[PreScheduler] Dispatch cycle complete:","dispatched="+s,"pending="+n.length,"retrying="+E.length),H=!1,q=setTimeout(V,z)},C=e=>{if(n.length===0)return;let t=n.length,s=[];for(let c=0;c<n.length;c++){let i=n[c];e(i)||s.push(i)}let r=t-s.length;r>0&&(n=s,Te(),o&&Atomics.add(o,12,r),I(),S("[PreScheduler] Cancelled "+r+" events, "+n.length+" remaining"))},Te=()=>{for(let e=Math.floor(n.length/2)-1;e>=0;e--)W(e)},he=(e,t)=>{C(s=>s.editorId===e&&s.runTag===t)},Re=e=>{C(t=>t.editorId===e)},Ae=e=>{C(t=>t.runTag===e)},me=()=>{if(n.length===0)return;let e=n.length;o&&Atomics.add(o,12,e),n=[],I(),S("[PreScheduler] Cancelled all "+e+" events")},Ie=e=>!e||e.length<8?!1:e[0]===35&&e[1]===98&&e[2]===117&&e[3]===110&&e[4]===100&&e[5]===108&&e[6]===101&&e[7]===0,Pe=e=>{let t=[],s=new DataView(e.buffer,e.byteOffset,e.byteLength),r=16;for(;r<e.length;){let c=s.getInt32(r,!1);if(r+=4,c<=0||r+c>e.length)break;let i=e.slice(r,r+c);for(t.push(i),r+=c;r%4!==0&&r<e.length;)r++}return t},De=e=>{if(Ie(e)){let t=Pe(e);for(let s=0;s<t.length;s++)T(t[s],!1)||m(t[s],"immediate bundle message "+s)}else T(e,!1)||m(e,"immediate message")};self.addEventListener("message",e=>{let{data:t}=e;try{switch(t.type){case"init":f=t.sharedBuffer,d=t.ringBufferBase,l=t.bufferConstants,t.maxPendingMessages&&(A=t.maxPendingMessages),Se(),pe(),S("[OSCPreSchedulerWorker] Initialized with NTP-based scheduling, capacity="+A),self.postMessage({type:"initialized"});break;case"send":ue(t.oscData,t.editorId||0,t.runTag||"");break;case"sendImmediate":De(t.oscData);break;case"cancelEditorTag":t.runTag!==void 0&&t.runTag!==null&&t.runTag!==""&&he(t.editorId||0,t.runTag);break;case"cancelEditor":Re(t.editorId||0);break;case"cancelTag":t.runTag!==void 0&&t.runTag!==null&&t.runTag!==""&&Ae(t.runTag);break;case"cancelAll":me();break;default:console.warn("[OSCPreSchedulerWorker] Unknown message type:",t.type)}}catch(s){console.error("[OSCPreSchedulerWorker] Error:",s),self.postMessage({type:"error",error:s.message})}});S("[OSCPreSchedulerWorker] Script loaded");})();
